<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile Mechanic Booking</title>
<style>
  /* Golden ratio layout */
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; line-height: 1.618; background: #f7f9fc; }
  header { background: #1e90ff; color: #fff; padding: 2rem; text-align: center; }
  main { max-width: 900px; margin: auto; padding: 2rem; }
  form { display: flex; flex-direction: column; gap: 1.618rem; background: #fff; padding: 2rem; border-radius: 10px; }
  label { font-weight: bold; }
  input, select, textarea { padding: 0.618rem; font-size: 1rem; border-radius: 5px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
  button { padding: 1rem; font-size: 1rem; background: #1e90ff; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
  button:hover { background: #0b66c3; }
  footer { text-align: center; padding: 1rem; font-size: 0.9rem; background: #e0e0e0; margin-top: 2rem; }
  .faq { margin-top: 2rem; }
  .faq-item { border-bottom: 1px solid #ccc; }
  .faq-item button { width: 100%; text-align: left; background: none; border: none; padding: 1rem; font-size: 1rem; cursor: pointer; }
  .faq-item p { display: none; padding: 1rem; margin: 0; }
  .faq-item.open p { display: block; }
  #map { height: 250px; margin-top: 1rem; border-radius: 10px; }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>

<header>
  <h1>Book Your Mobile Mechanic</h1>
</header>

<main>
  <form id="bookingForm">
    <label for="name">Full Name</label>
    <input type="text" id="name" required>

    <label for="phone">Phone (UK)</label>
    <input type="tel" id="phone" pattern="^(\+44\s?7\d{3}|\(?07\d{3}\)?)\s?\d{3}\s?\d{3}$" placeholder="07123 456 789" required>

    <label for="email">Email</label>
    <input type="email" id="email" placeholder="example@email.com" required>

    <label for="regPlate">Registration Plate</label>
    <input type="text" id="regPlate" placeholder="AB12 CDE" maxlength="8" required>

    <label for="service">Service Required</label>
    <select id="service" required>
      <option value="">Select a service</option>
      <option value="oil_change">Oil Change - Change engine oil and filter</option>
      <option value="brake_check">Brake Check - Inspect and replace pads if needed</option>
      <option value="battery_replace">Battery Replacement - Replace car battery</option>
    </select>

    <label for="address">Address</label>
    <input type="text" id="address" placeholder="Detecting location..." required readonly>

    <div id="map"></div>

    <button type="submit">Book Service</button>
    <div id="bookingStatus"></div>
  </form>

  <div class="faq">
    <h2>FAQs</h2>
    <div class="faq-item">
      <button type="button">How long does a service take?</button>
      <p>Most standard services take 30-60 minutes depending on the work.</p>
    </div>
    <div class="faq-item">
      <button type="button">Do you provide parts?</button>
      <p>Yes, all standard parts are included in the service cost.</p>
    </div>
    <div class="faq-item">
      <button type="button">Can I reschedule?</button>
      <p>Yes, you can reschedule 24 hours before the booking.</p>
    </div>
  </div>
</main>

<footer id="footer">
  Database status: <span id="dbStatus">Checking...</span>
</footer>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // FAQ accordion
  document.querySelectorAll('.faq-item button').forEach(btn => {
    btn.addEventListener('click', () => {
      const item = btn.parentElement;
      item.classList.toggle('open');
    });
  });

  // Location detection
  const addressInput = document.getElementById('address');
  let userCoords = null;

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      userCoords = [pos.coords.latitude, pos.coords.longitude];
      addressInput.value = `Lat: ${userCoords[0].toFixed(6)}, Lon: ${userCoords[1].toFixed(6)}`;

      const map = L.map('map').setView(userCoords, 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      L.marker(userCoords).addTo(map).bindPopup("You are here").openPopup();
    }, err => {
      addressInput.value = "Unable to detect location";
    });
  }

  // Number plate formatting
  const regInput = document.getElementById('regPlate');
  regInput.addEventListener('input', () => {
    let value = regInput.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    if (value.length > 4) {
      value = value.slice(0,4) + ' ' + value.slice(4);
    }
    regInput.value = value;
  });

  // Booking form submit
  const form = document.getElementById('bookingForm');
  form.addEventListener('submit', async e => {
    e.preventDefault();
    const name = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const email = document.getElementById('email').value.trim();
    const regPlate = document.getElementById('regPlate').value.trim();
    const service = document.getElementById('service').value;
    const address = document.getElementById('address').value;

    if (!name || !phone || !email || !regPlate || !service || !address) {
      document.getElementById('bookingStatus').textContent = "Booking failed: Missing fields";
      return;
    }

    // Send booking to backend
    try {
      const res = await fetch('https://sos911.onrender.com/api/bookings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, phone, email, regPlate, service, address, lat: userCoords[0], lon: userCoords[1] })
      });
      const data = await res.json();
      if (data.success) {
        document.getElementById('bookingStatus').textContent = "✅ Booking successful!";
      } else {
        document.getElementById('bookingStatus').textContent = "❌ Booking failed: " + data.error;
      }
    } catch(err) {
      document.getElementById('bookingStatus').textContent = "❌ Booking failed: " + err.message;
    }
  });

  // Database status fetch
  async function checkDB() {
    try {
      const res = await fetch('https://sos911.onrender.com/api/db-status');
      const data = await res.json();
      document.getElementById('dbStatus').textContent = data.connected ? "Connected" : "Not connected";
    } catch(err) {
      document.getElementById('dbStatus').textContent = "Not connected: " + err.message;
    }
  }
  checkDB();
</script>

</body>
</html>