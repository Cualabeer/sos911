<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Book Mobile Mechanic Service</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin:0;
    padding:0;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    background:#f5f5f5;
  }
  .container {
    max-width:800px;
    width:90%;
    background:#fff;
    margin-top:50px;
    padding:2rem;
    border-radius:10px;
    box-shadow:0 0 10px rgba(0,0,0,0.1);
  }
  h1 {
    text-align:center;
    margin-bottom:2rem;
  }
  label {
    display:block;
    margin-top:1.5rem;
    font-weight:bold;
  }
  input, select {
    width:100%;
    padding:0.75rem;
    font-size:1rem;
    border:1px solid #ccc;
    border-radius:5px;
    margin-top:0.5rem;
  }
  button {
    background:#007bff;
    color:#fff;
    border:none;
    padding:1rem;
    font-size:1rem;
    margin-top:2rem;
    width:100%;
    border-radius:5px;
    cursor:pointer;
  }
  button:hover {
    background:#0056b3;
  }
  #ticket-popup {
    display:none;
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    background:#fff;
    padding:2rem;
    border-radius:10px;
    box-shadow:0 0 15px rgba(0,0,0,0.3);
    z-index:1000;
  }
  #ticket-popup img {
    max-width:100%;
  }
  #overlay {
    display:none;
    position:fixed;
    top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.5);
    z-index:500;
  }
  footer {
    text-align:center;
    margin-top:2rem;
    font-size:0.9rem;
    color:#555;
  }
</style>
</head>
<body>
<div class="container">
  <h1>Book a Service</h1>
  <form id="booking-form">
    <label for="name">Full Name</label>
    <input type="text" id="name" name="name" required>

    <label for="phone">Phone Number</label>
    <input type="tel" id="phone" name="phone" required>

    <label for="email">Email</label>
    <input type="email" id="email" name="email" required>

    <label for="service">Service</label>
    <select id="service" required></select>

    <label for="number_plate">Vehicle Number Plate</label>
    <input type="text" id="number_plate" name="number_plate" maxlength="8" placeholder="AB12 CDE" required>

    <label for="location">Location</label>
    <input type="text" id="location" name="location" placeholder="Detecting..." required>

    <label for="date">Preferred Date & Time</label>
    <input type="datetime-local" id="date" name="date" required>

    <button type="submit">Book Service</button>
  </form>
</div>

<div id="overlay"></div>
<div id="ticket-popup">
  <h2>Your Booking Ticket</h2>
  <p>Screenshot or download for arrival</p>
  <img id="qr-image" src="">
  <button onclick="closeTicket()">Close</button>
</div>

<footer id="db-status">Checking database...</footer>

<script>
const API_URL = 'https://sos911.onrender.com';

async function checkDb() {
  try {
    const res = await fetch(`${API_URL}/db-status`);
    const data = await res.json();
    document.getElementById('db-status').textContent = data.status;
  } catch(e){
    document.getElementById('db-status').textContent = 'Database not connected';
  }
}

checkDb();

async function loadServices() {
  const res = await fetch(`${API_URL}/services`);
  const services = await res.json();
  const serviceSelect = document.getElementById('service');
  services.forEach(s=>{
    const opt = document.createElement('option');
    opt.value = s.id;
    opt.textContent = `${s.name} - Â£${s.price}`;
    serviceSelect.appendChild(opt);
  });
}

loadServices();

// Auto-detect location
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(async pos=>{
    const { latitude, longitude } = pos.coords;
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
    const data = await res.json();
    document.getElementById('location').value = data.display_name || `${latitude}, ${longitude}`;
  });
}

// Number plate formatting UK
document.getElementById('number_plate').addEventListener('input', e=>{
  e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,'');
  if(e.target.value.length>4) e.target.value = e.target.value.slice(0,4)+' '+e.target.value.slice(4);
});

const form = document.getElementById('booking-form');
form.addEventListener('submit', async e=>{
  e.preventDefault();
  const booking = {
    customer:{
      name: document.getElementById('name').value,
      phone: document.getElementById('phone').value,
      email: document.getElementById('email').value
    },
    service_id: document.getElementById('service').value,
    number_plate: document.getElementById('number_plate').value,
    location: document.getElementById('location').value,
    date: document.getElementById('date').value
  };

  try{
    const res = await fetch(`${API_URL}/bookings`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(booking)
    });
    const data = await res.json();
    if(data.error) {
      alert('Booking failed: '+data.error);
    } else {
      document.getElementById('qr-image').src = data.qr_code;
      document.getElementById('overlay').style.display='block';
      document.getElementById('ticket-popup').style.display='block';
    }
  }catch(err){
    alert('Booking failed: '+err.message);
  }
});

function closeTicket(){
  document.getElementById('ticket-popup').style.display='none';
  document.getElementById('overlay').style.display='none';
}
</script>
</body>
</html>