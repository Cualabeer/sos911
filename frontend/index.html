<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Customer Booking</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background: #f8f9fa; }
  .container { max-width: 600px; margin-top: 50px; }
  .form-control { margin-bottom: 15px; }
  #qrModal img { width: 100%; }
  #diagnostics { max-height: 300px; overflow-y: auto; }
</style>
</head>
<body>

<div class="container">
  <h1 class="text-center mb-4">Book a Service</h1>
  <form id="bookingForm">
    <input type="text" class="form-control" id="name" placeholder="Full Name" required>
    <input type="email" class="form-control" id="email" placeholder="Email" required>
    <input type="text" class="form-control" id="phone" placeholder="UK Phone Number" required pattern="^0\d{10}$">
    <input type="text" class="form-control" id="reg_plate" placeholder="Registration Plate (UK)" required pattern="^[A-Z]{2}[0-9]{2}[A-Z]{3}$">
    <select class="form-control" id="service" required></select>
    <input type="text" class="form-control" id="location" placeholder="Your Location" required readonly>
    <button type="submit" class="btn btn-primary w-100">Book Service</button>
  </form>
</div>

<!-- QR Modal -->
<div class="modal fade" id="qrModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Booking QR Code</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="qrImage" src="" alt="QR Code">
        <p id="qrText"></p>
      </div>
    </div>
  </div>
</div>

<!-- Footer Diagnostics -->
<footer class="text-center mt-4 p-3 bg-light fixed-bottom">
  <button class="btn btn-sm btn-secondary" id="checkDiag">Diagnostics</button>
  <div id="diagResults" class="mt-2"></div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
const form = document.getElementById('bookingForm');
const serviceSelect = document.getElementById('service');
const locationInput = document.getElementById('location');
const qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
const qrImage = document.getElementById('qrImage');
const qrText = document.getElementById('qrText');
const diagResults = document.getElementById('diagResults');

function fetchServices() {
  axios.get('/api/services').then(res => {
    serviceSelect.innerHTML = res.data.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
  });
}

// Auto-detect location
function detectLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      locationInput.value = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
    }, err => { locationInput.value = 'Location not available'; });
  }
}

// Capitalize reg plate as user types
const regPlate = document.getElementById('reg_plate');
regPlate.addEventListener('input', e => {
  e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,'');
});

form.addEventListener('submit', async e => {
  e.preventDefault();
  try {
    const payload = {
      customer_id: 1, // For demo, static customer
      service_id: serviceSelect.value,
      location: locationInput.value
    };
    const res = await axios.post('/api/book', payload);
    qrImage.src = res.data.qr_code;
    qrText.innerText = `Booking ID: ${res.data.id}`;
    qrModal.show();
  } catch(err) {
    alert('Booking Failed: ' + (err.response?.data?.error || err.message));
  }
});

// Diagnostics
document.getElementById('checkDiag').addEventListener('click', async () => {
  diagResults.innerHTML = 'Loading...';
  try {
    const db = await axios.get('/api/db-status');
    const services = await axios.get('/api/services');
    const bookings = await axios.get('/api/bookings');
    diagResults.innerHTML = `
      <ul>
        <li>Database: ${db.data.status}</li>
        <li>Services loaded: ${services.data.length}</li>
        <li>Bookings loaded: ${bookings.data.length}</li>
      </ul>
    `;
  } catch(err) {
    diagResults.innerHTML = 'Diagnostics failed: ' + err.message;
  }
});

// Initialize
fetchServices();
detectLocation();
</script>
</body>
</html>