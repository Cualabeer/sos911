<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile Mechanic Booking</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body {font-family: Arial, sans-serif; margin:0; padding:0;}
.hero {background:#007bff; color:#fff; padding:60px 20px; text-align:center;}
.hero h1 {font-size:2.5rem; margin-bottom:20px;}
.hero button {font-size:1.2rem;}
.carousel-item {text-align:center;}
.service-card {margin:10px; padding:20px; border:1px solid #ddd; border-radius:8px; background:#fff;}
.faq-section {margin:40px 0;}
footer {position:fixed; bottom:0; width:100%; background:#f8f9fa; padding:10px; cursor:pointer;}
#diagPanel {display:none; max-height:300px; overflow-y:auto; background:#e9ecef; padding:10px; border-top:1px solid #ccc;}
</style>
</head>
<body>

<!-- Hero Section -->
<section class="hero">
  <h1>Quick Mobile Mechanic Service</h1>
  <p>Book your service in seconds, anywhere in Medway</p>
  <button class="btn btn-light" onclick="openBooking()">Book Now</button>
</section>

<!-- Services Carousel -->
<section class="container my-5">
  <h2 class="mb-3">Our Services</h2>
  <div id="servicesCarousel" class="carousel slide" data-bs-ride="carousel">
    <div class="carousel-inner" id="servicesContainer"></div>
    <button class="carousel-control-prev" type="button" data-bs-target="#servicesCarousel" data-bs-slide="prev">
      <span class="carousel-control-prev-icon"></span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#servicesCarousel" data-bs-slide="next">
      <span class="carousel-control-next-icon"></span>
    </button>
  </div>
</section>

<!-- FAQ Section -->
<section class="container faq-section">
  <h2>FAQ</h2>
  <div class="accordion" id="faqAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">How do I book?</button></h2>
      <div id="faq1" class="accordion-collapse collapse"><div class="accordion-body">Click "Book Now", select service, and enter details.</div></div>
    </div>
    <div class="accordion-item">
      <h2 class="accordion-header"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">Do you come to my location?</button></h2>
      <div id="faq2" class="accordion-collapse collapse"><div class="accordion-body">Yes, we service all Medway areas.</div></div>
    </div>
  </div>
</section>

<!-- Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <h5>Book Service</h5>
      <form id="bookingForm">
        <input class="form-control mb-2" name="name" placeholder="Full Name" required>
        <input class="form-control mb-2" type="email" name="email" placeholder="Email" required>
        <input class="form-control mb-2" name="phone" placeholder="Phone 07XXXXXXXXX" required>
        <input class="form-control mb-2" name="reg_plate" placeholder="Reg Plate (AB12 CDE)" required>
        <input class="form-control mb-2" name="address" placeholder="Address" required>
        <select class="form-control mb-2" name="service_id" required></select>
        <input class="form-control mb-2" name="postcode" placeholder="Postcode" required>
        <button class="btn btn-primary w-100" type="submit">Confirm Booking</button>
      </form>
      <div id="qrTicket" class="text-center mt-3"></div>
    </div>
  </div>
</div>

<!-- Footer Diagnostics -->
<footer onclick="toggleDiag()">Diagnostics</footer>
<div id="diagPanel"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Load services into carousel and select dropdown
async function loadServices(){
  try{
    const res = await fetch('/api/services');
    const services = await res.json();
    const container = document.getElementById('servicesContainer');
    const select = document.querySelector('[name="service_id"]');
    services.forEach((s,i)=>{
      const active = i===0?'active':'';
      container.innerHTML+=`<div class="carousel-item ${active}"><div class="service-card"><h5>${s.name}</h5><p>${s.description}</p></div></div>`;
      select.innerHTML+=`<option value="${s.id}">${s.name}</option>`;
    });
  }catch(e){ console.error(e); }
}

// Booking modal
function openBooking(){new bootstrap.Modal(document.getElementById('bookingModal')).show();}

// Booking submission
document.getElementById('bookingForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const form = e.target;
  const data = Object.fromEntries(new FormData(form));
  try{
    const res = await fetch('/api/bookings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    const result = await res.json();
    if(result.qr_code) document.getElementById('qrTicket').innerHTML=`<img src="${result.qr_code}" style="width:200px;">`;
    alert('Booking confirmed!');
  }catch(err){alert('Booking failed: '+err.message);}
});

// Toggle diagnostics panel
async function toggleDiag(){
  const panel = document.getElementById('diagPanel');
  panel.style.display = panel.style.display==='block'?'none':'block';
  if(panel.style.display==='block'){
    try{
      const res = await fetch('/api/diagnostics');
      const diag = await res.json();
      panel.innerHTML=`
        <strong>Database:</strong> ${diag.db_status}<br>
        <strong>Services:</strong> ${diag.services}<br>
        <strong>Bookings:</strong> ${diag.bookings}<br>
        <strong>Customers:</strong> ${diag.customers}
      `;
    }catch(e){panel.innerHTML='Diagnostics failed: '+e.message;}
  }
}

// Initial load
loadServices();
</script>
</body>
</html>