<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Customer Booking</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  html, body { height:100%; margin:0; }
  #bookingForm { max-width: 700px; margin: auto; padding:2rem; }
  #diagPanel { position:fixed; bottom:0; left:0; width:100%; background:#f8f9fa; max-height:50%; overflow:auto; border-top:2px solid #007bff; display:none; }
  #diagPanel pre { margin:0; padding:1rem; font-size:0.85rem; }
  #map { height:200px; margin-bottom:1rem; }
</style>
</head>
<body>
<div id="bookingForm" class="container">
  <h2 class="mb-4 text-center">Book a Service</h2>
  <form id="form">
    <div class="mb-3">
      <label>Name</label>
      <input type="text" id="name" class="form-control" required>
    </div>
    <div class="mb-3">
      <label>Email</label>
      <input type="email" id="email" class="form-control" required>
    </div>
    <div class="mb-3">
      <label>Phone</label>
      <input type="tel" id="phone" class="form-control" pattern="^07[0-9]{9}$" required>
    </div>
    <div class="mb-3">
      <label>Number Plate</label>
      <input type="text" id="numberPlate" class="form-control" required>
    </div>
    <div class="mb-3">
      <label>Service</label>
      <select id="service" class="form-select" required></select>
    </div>
    <div class="mb-3">
      <label>Address</label>
      <input type="text" id="address" class="form-control" required>
    </div>
    <div id="map"></div>
    <button type="submit" class="btn btn-primary w-100">Book Service</button>
  </form>
</div>

<!-- Diagnostics footer -->
<div class="text-center p-2 bg-light border-top">
  <span id="dbStatus">DB: checking...</span>
  <button id="diagBtn" class="btn btn-sm btn-info ms-2">Diagnostics</button>
</div>

<div id="diagPanel">
  <button id="closeDiag" class="btn btn-sm btn-danger m-2">Close</button>
  <pre id="diagContent"></pre>
</div>

<!-- QR Modal -->
<div class="modal fade" id="qrModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3 text-center">
      <h5>Booking QR Code</h5>
      <img id="qrImg" alt="QR Code"/>
      <button class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let lat, lng;

// Load services
async function loadServices() {
  const res = await fetch('/api/services');
  const services = await res.json();
  const sel = document.getElementById('service');
  services.forEach(s => sel.add(new Option(s.name, s.id)));
}

// DB Status
async function checkDB() {
  try {
    const res = await fetch('/api/db-status');
    const data = await res.json();
    document.getElementById('dbStatus').textContent = data.connected ? 'DB: Connected ✅' : 'DB: ❌ ' + data.error;
  } catch(e){
    document.getElementById('dbStatus').textContent = 'DB: ❌ ' + e.message;
  }
}

// Diagnostics panel
document.getElementById('diagBtn').onclick = async ()=>{
  const panel = document.getElementById('diagPanel');
  panel.style.display='block';
  const diag = [];
  try{
    const db = await fetch('/api/db-status').then(r=>r.json());
    diag.push('Database Connection: ' + (db.connected?'OK ✅':'FAIL ❌'));
    const serv = await fetch('/api/services').then(r=>r.json());
    diag.push('Services Loaded: ' + serv.length);
    const book = await fetch('/api/bookings').then(r=>r.json());
    diag.push('Bookings Loaded: ' + book.length);
    diag.push('Geolocation: Lat='+lat+', Lng='+lng);
  }catch(e){ diag.push('Error: '+e.message);}
  document.getElementById('diagContent').textContent = diag.join('\n');
};
document.getElementById('closeDiag').onclick = ()=>{document.getElementById('diagPanel').style.display='none';}

// Geolocation + map
navigator.geolocation.getCurrentPosition(pos=>{
  lat=pos.coords.latitude; lng=pos.coords.longitude;
  document.getElementById('address').value = 'Lat:'+lat+', Lng:'+lng;
  const map = L.map('map').setView([lat,lng],15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  L.marker([lat,lng]).addTo(map).bindPopup('Your Location').openPopup();
});

// Booking form
document.getElementById('form').onsubmit = async e=>{
  e.preventDefault();
  const np = document.getElementById('numberPlate');
  np.value = np.value.toUpperCase().replace(/\s+/g,''); // auto caps & remove spaces
  const body = {
    name: document.getElementById('name').value,
    email: document.getElementById('email').value,
    phone: document.getElementById('phone').value,
    numberPlate: np.value,
    address: document.getElementById('address').value,
    lat, lng,
    serviceId: document.getElementById('service').value
  };
  const res = await fetch('/api/bookings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  const data = await res.json();
  if(data.success){
    const qrRes = await fetch(`/api/qr?bookingId=${data.id}`);
    const qrBlob = await qrRes.blob();
    document.getElementById('qrImg').src = URL.createObjectURL(qrBlob);
    const modal = new bootstrap.Modal(document.getElementById('qrModal'));
    modal.show();
  } else {
    alert('Booking failed: '+data.error);
  }
};

// Init
loadServices();
checkDB();
</script>
</body>
</html>