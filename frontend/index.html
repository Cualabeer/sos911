<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile Mechanic Booking</title>
<style>
  body { font-family: Arial, sans-serif; background: #f5f5f5; margin:0; padding:0;}
  header { background: #003366; color: #fff; padding: 1rem; text-align: center;}
  main { max-width: 600px; margin: 2rem auto; background: #fff; padding: 2rem; border-radius: 8px; }
  label { display:block; margin-top:1rem; }
  input, select, button { width:100%; padding:0.5rem; margin-top:0.3rem; border-radius:4px; border:1px solid #ccc; }
  button { background: #003366; color:#fff; border:none; cursor:pointer; }
  button:hover { background:#0055aa; }
  #ticketPopup { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); 
                background:#fff; padding:2rem; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.3);}
  #ticketPopup h2 { margin-top:0; }
  #closeTicket { margin-top:1rem; }
</style>
</head>
<body>

<header>
  <h1>Book Mobile Mechanic</h1>
</header>

<main>
  <form id="bookingForm">
    <label for="name">Full Name</label>
    <input type="text" id="name" required>

    <label for="email">Email</label>
    <input type="email" id="email" required>

    <label for="phone">Phone</label>
    <input type="tel" id="phone" required>

    <label for="vehicle_plate">Vehicle Plate</label>
    <input type="text" id="vehicle_plate" required placeholder="AB12 CDE">

    <label for="service">Select Service</label>
    <select id="service" required>
      <option value="">Loading services...</option>
    </select>

    <label for="address">Address</label>
    <input type="text" id="address" required readonly>

    <button type="submit">Book Now</button>
  </form>
</main>

<div id="ticketPopup">
  <h2>Your Booking Ticket</h2>
  <p id="ticketInfo"></p>
  <canvas id="qrCode"></canvas>
  <button id="closeTicket">Close</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<script>
const API_BASE = 'https://sos911.onrender.com'; // backend URL

// Auto geolocate
function setLocation() {
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(async pos => {
      const lat = pos.coords.latitude.toFixed(6);
      const lng = pos.coords.longitude.toFixed(6);
      document.getElementById('address').dataset.latlng = `${lat},${lng}`;

      // Free reverse geocode
      const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`);
      const data = await resp.json();
      document.getElementById('address').value = data.display_name || '';
    }, err => {
      console.error('Location error:', err);
    });
  }
}

// Load services from backend
async function loadServices() {
  const sel = document.getElementById('service');
  try {
    const resp = await fetch(`${API_BASE}/services`);
    const services = await resp.json();
    sel.innerHTML = '<option value="">Select Service</option>';
    services.forEach(s => {
      sel.innerHTML += `<option value="${s.id}">${s.name} (Â£${s.base_price})</option>`;
    });
  } catch(err) {
    console.error(err);
    sel.innerHTML = '<option value="">Failed to load services</option>';
  }
}

// Booking form submit
document.getElementById('bookingForm').addEventListener('submit', async e => {
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  const email = document.getElementById('email').value.trim();
  const phone = document.getElementById('phone').value.trim();
  let vehicle_plate = document.getElementById('vehicle_plate').value.toUpperCase().replace(/\s+/g,'');
  vehicle_plate = vehicle_plate.slice(0,2)+' '+vehicle_plate.slice(2,4)+' '+vehicle_plate.slice(4);

  const service_id = document.getElementById('service').value;
  const address = document.getElementById('address').value;
  const latlng = document.getElementById('address').dataset.latlng?.split(',') || [];

  if(!name || !email || !phone || !vehicle_plate || !service_id || !address) return alert('Fill all fields');

  try {
    const resp = await fetch(`${API_BASE}/book`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({name,email,phone,vehicle_plate,service_id,address,lat:latlng[0],lng:latlng[1]})
    });
    const result = await resp.json();
    if(result.booking_id){
      showTicket({id: result.booking_id, name, vehicle_plate, service_id, address});
    } else {
      alert('Booking failed');
    }
  } catch(err){
    console.error(err);
    alert('Booking failed');
  }
});

// Show ticket popup with QR
function showTicket({id,name,vehicle_plate,service_id,address}){
  const popup = document.getElementById('ticketPopup');
  document.getElementById('ticketInfo').innerHTML = `
    <strong>Booking ID:</strong> ${id}<br>
    <strong>Name:</strong> ${name}<br>
    <strong>Plate:</strong> ${vehicle_plate}<br>
    <strong>Service:</strong> ${service_id}<br>
    <strong>Address:</strong> ${address}
  `;
  QRCode.toCanvas(document.getElementById('qrCode'), `booking:${id}`, {width:128});
  popup.style.display = 'block';
}

// Close ticket
document.getElementById('closeTicket').addEventListener('click', () => {
  document.getElementById('ticketPopup').style.display='none';
});

// Initialize
loadServices();
setLocation();
</script>

</body>
</html>