<!-- frontend/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile Mechanic Booking</title>
<link rel="stylesheet" href="style.css">
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f7f7f7; }
  header { background:#003366; color:#fff; padding:1rem; display:flex; justify-content:space-between; align-items:center; }
  header h1 { margin:0; font-size:1.5rem; }
  .btn { background:#ffcc00; border:none; padding:.5rem 1rem; cursor:pointer; border-radius:5px; font-weight:bold; }
  .carousel { display:flex; overflow-x:auto; scroll-snap-type:x mandatory; padding:1rem; gap:1rem; }
  .card { background:#fff; min-width:250px; flex:0 0 auto; border-radius:10px; padding:1rem; box-shadow:0 2px 6px rgba(0,0,0,0.2); scroll-snap-align:start; }
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1000; }
  .modal-content { background:#fff; padding:2rem; border-radius:10px; max-width:400px; width:90%; position:relative; }
  .modal-content h2 { margin-top:0; }
  .close { position:absolute; top:10px; right:15px; cursor:pointer; font-weight:bold; font-size:1.2rem; }
  .qr-code { width:200px; height:200px; margin:1rem auto; display:block; }
  nav { display:flex; gap:1rem; }
  .hidden { display:none; }
</style>
</head>
<body>

<header>
  <h1>Mobile Mechanic</h1>
  <nav>
    <button class="btn" id="loginBtn">Login/Register</button>
    <button class="btn" id="bookingBtn">Book Now</button>
    <span id="welcomeMsg" class="hidden"></span>
  </nav>
</header>

<section id="hero" style="padding:1rem; text-align:center;">
  <h2>Fast Mobile Mechanic Service at Your Doorstep</h2>
  <p>Book, track, and pay for your vehicle service quickly and safely.</p>
</section>

<section>
  <h3 style="padding-left:1rem;">Our Services</h3>
  <div class="carousel" id="servicesCarousel">
    <!-- Service cards will be populated here -->
  </div>
</section>

<section id="bookingHistory" class="hidden" style="padding:1rem;">
  <h3>Your Bookings</h3>
  <ul id="bookingList"></ul>
</section>

<!-- Login/Register Modal -->
<div class="modal" id="loginModal">
  <div class="modal-content">
    <span class="close" id="closeLogin">&times;</span>
    <h2>Login / Register</h2>
    <form id="loginForm">
      <input type="email" id="loginEmail" placeholder="Email" required style="width:100%;margin:.5rem 0;padding:.5rem;">
      <input type="password" id="loginPassword" placeholder="Password" required style="width:100%;margin:.5rem 0;padding:.5rem;">
      <button type="submit" class="btn" style="width:100%;">Login</button>
      <p style="text-align:center;margin:.5rem 0;">Or Register Below</p>
      <input type="text" id="regName" placeholder="Name" required style="width:100%;margin:.5rem 0;padding:.5rem;">
      <input type="text" id="regPhone" placeholder="Phone (07XXXXXXXXX)" required style="width:100%;margin:.5rem 0;padding:.5rem;">
      <input type="text" id="regRegPlate" placeholder="Car Reg Plate (AB12 CDE)" required style="width:100%;margin:.5rem 0;padding:.5rem;">
      <input type="text" id="regAddress" placeholder="Address" required style="width:100%;margin:.5rem 0;padding:.5rem;">
      <input type="email" id="regEmail" placeholder="Email" required style="width:100%;margin:.5rem 0;padding:.5rem;">
      <input type="password" id="regPassword" placeholder="Password" required style="width:100%;margin:.5rem 0;padding:.5rem;">
      <button type="button" id="registerBtn" class="btn" style="width:100%;margin-top:.5rem;">Register</button>
    </form>
  </div>
</div>

<!-- Booking Modal -->
<div class="modal" id="bookingModal">
  <div class="modal-content">
    <span class="close" id="closeBooking">&times;</span>
    <h2>Book a Service</h2>
    <select id="serviceSelect" style="width:100%;margin:.5rem 0;padding:.5rem;"></select>
    <input type="text" id="bookingLocation" placeholder="Location" style="width:100%;margin:.5rem 0;padding:.5rem;">
    <input type="text" id="bookingPostcode" placeholder="Postcode" style="width:100%;margin:.5rem 0;padding:.5rem;">
    <button id="bookServiceBtn" class="btn" style="width:100%;">Confirm Booking</button>
    <img id="bookingQRCode" class="qr-code hidden" />
  </div>
</div>

<script>
let currentUser = null;

// Modal logic
const loginModal = document.getElementById("loginModal");
const bookingModal = document.getElementById("bookingModal");
document.getElementById("loginBtn").onclick = ()=> loginModal.style.display = "flex";
document.getElementById("bookingBtn").onclick = ()=> bookingModal.style.display = "flex";
document.getElementById("closeLogin").onclick = ()=> loginModal.style.display = "none";
document.getElementById("closeBooking").onclick = ()=> bookingModal.style.display = "none";

// Load services
async function loadServices(){
  const res = await fetch("/api/diagnostics");
  const data = await res.json();
  const carousel = document.getElementById("servicesCarousel");
  const serviceRes = await fetch("/api/services");
  const servicesData = await serviceRes.json();
  servicesData.forEach(s=>{
    const card = document.createElement("div");
    card.className="card";
    card.innerHTML=`<h4>${s.name}</h4><p>${s.description}</p>`;
    carousel.appendChild(card);
    const option = document.createElement("option");
    option.value=s.id;
    option.textContent = s.name;
    document.getElementById("serviceSelect").appendChild(option);
  });
}

// Login
document.getElementById("loginForm").onsubmit = async (e)=>{
  e.preventDefault();
  const email = document.getElementById("loginEmail").value;
  const password = document.getElementById("loginPassword").value;
  const res = await fetch("/api/customers/login", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({email,password})
  });
  const data = await res.json();
  if(data.error){ alert(data.error); return; }
  currentUser = data;
  loginModal.style.display="none";
  document.getElementById("welcomeMsg").textContent=`Welcome, ${data.name}`;
  document.getElementById("welcomeMsg").classList.remove("hidden");
  loadBookingHistory();
};

// Register
document.getElementById("registerBtn").onclick = async ()=>{
  const payload = {
    name: document.getElementById("regName").value,
    phone: document.getElementById("regPhone").value,
    reg_plate: document.getElementById("regRegPlate").value,
    address: document.getElementById("regAddress").value,
    email: document.getElementById("regEmail").value,
    password: document.getElementById("regPassword").value
  };
  const res = await fetch("/api/customers/register", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  if(data.error){ alert(data.error); return; }
  alert("Registered! Please login.");
};

// Booking
document.getElementById("bookServiceBtn").onclick = async ()=>{
  if(!currentUser){ alert("Please login first."); return; }
  const payload = {
    customer_id: currentUser.id,
    service_id: document.getElementById("serviceSelect").value,
    location: document.getElementById("bookingLocation").value,
    postcode: document.getElementById("bookingPostcode").value
  };
  const res = await fetch("/api/bookings", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  if(data.error){ alert(data.error); return; }
  document.getElementById("bookingQRCode").src = data.qr_code;
  document.getElementById("bookingQRCode").classList.remove("hidden");
  loadBookingHistory();
};

// Load Booking History
async function loadBookingHistory(){
  const res = await fetch(`/api/customers/${currentUser.id}/bookings`);
  const bookings = await res.json();
  const list = document.getElementById("bookingList");
  list.innerHTML="";
  bookings.forEach(b=>{
    const li = document.createElement("li");
    li.textContent = `${b.service_name} at ${b.location} (${b.status})`;
    list.appendChild(li);
  });
}

// Init
loadServices();
</script>

</body>
</html>