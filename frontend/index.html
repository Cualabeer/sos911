<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SOS Mechanics - Book Service</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .container { max-width: 900px; margin: auto; padding: 2rem; }
    .footer { position: fixed; bottom: 0; left: 0; width: 100%; background: #007bff; color: #fff; padding: 1rem; text-align: center; z-index: 1000; cursor: pointer; }
    #diagnosticsPanel { display: none; position: fixed; bottom: 0; left: 0; width: 100%; max-height: 80%; overflow-y: auto; background: #f8f9fa; border-top: 3px solid #007bff; padding: 1rem; z-index: 1100; box-shadow: 0 -3px 10px rgba(0,0,0,0.2); }
    .diag-section { border-bottom: 1px solid #ddd; margin-bottom: 0.5rem; padding-bottom: 0.5rem; }
    .diag-header { font-weight: bold; }
    .status-ok { color: green; font-weight: bold; }
    .status-fail { color: red; font-weight: bold; }
    .status-warn { color: orange; font-weight: bold; }
    .form-floating { margin-bottom: 1rem; }
  </style>
</head>
<body>

  <div class="container">
    <h1 class="mb-4">Book a Mobile Service</h1>
    <form id="bookingForm">
      <div class="form-floating">
        <input type="text" class="form-control" id="name" placeholder="Full Name" required>
        <label for="name">Full Name</label>
      </div>

      <div class="form-floating">
        <input type="tel" class="form-control" id="phone" placeholder="Phone Number" required>
        <label for="phone">Phone (UK)</label>
      </div>

      <div class="form-floating">
        <input type="text" class="form-control" id="email" placeholder="Email" required>
        <label for="email">Email</label>
      </div>

      <div class="form-floating">
        <input type="text" class="form-control" id="numberPlate" placeholder="Vehicle Registration" required>
        <label for="numberPlate">Number Plate</label>
      </div>

      <div class="form-floating">
        <input type="text" class="form-control" id="address" placeholder="Address" required>
        <label for="address">Address</label>
      </div>

      <div class="form-floating">
        <select class="form-select" id="service" required>
          <option value="">Select Service</option>
          <option value="oil-change">Oil Change</option>
          <option value="brake-check">Brake Check</option>
          <option value="battery-replacement">Battery Replacement</option>
        </select>
        <label for="service">Service</label>
      </div>

      <button type="submit" class="btn btn-primary w-100">Book Service</button>
      <div id="formMessage" class="mt-3"></div>
    </form>
  </div>

  <div class="footer" id="diagnosticsBtn">Check System Diagnostics</div>

  <div id="diagnosticsPanel">
    <h5>System Diagnostics</h5>
    <div id="diagContent"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script>
    // ---------- Form Validation ----------
    const bookingForm = document.getElementById('bookingForm');
    const formMessage = document.getElementById('formMessage');

    function validateUKPhone(phone) {
      return /^(\+44\s?7\d{3}|\(?07\d{3}\)?)\s?\d{3}\s?\d{3}$/.test(phone);
    }

    function validateUKPlate(plate) {
      return /^[A-Z]{2}[0-9]{2}\s?[A-Z]{3}$/.test(plate.toUpperCase());
    }

    function validateEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    bookingForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();
      let plate = document.getElementById('numberPlate').value.trim().toUpperCase();
      plate = plate.replace(/ /g, '');
      plate = plate.slice(0,4) + ' ' + plate.slice(4); // simple spacing
      document.getElementById('numberPlate').value = plate;
      const address = document.getElementById('address').value.trim();
      const service = document.getElementById('service').value;

      if (!name || !validateUKPhone(phone) || !validateEmail(email) || !validateUKPlate(plate) || !address || !service) {
        formMessage.innerHTML = '<span class="text-danger">Booking Failed: Missing or invalid fields</span>';
        return;
      }

      try {
        const res = await axios.post('https://sos911.onrender.com/api/bookings', {
          name, phone, email, numberPlate: plate, address, service
        });
        formMessage.innerHTML = '<span class="text-success">Booking Successful!</span>';
      } catch (err) {
        formMessage.innerHTML = `<span class="text-danger">Booking Failed: ${err.response?.data?.message || err.message}</span>`;
      }
    });

    // ---------- Diagnostics ----------
    const diagBtn = document.getElementById('diagnosticsBtn');
    const diagPanel = document.getElementById('diagnosticsPanel');
    const diagContent = document.getElementById('diagContent');

    diagBtn.addEventListener('click', async () => {
      diagPanel.style.display = diagPanel.style.display === 'block' ? 'none' : 'block';
      diagContent.innerHTML = '<p>Checking...</p>';

      const diagnostics = [];

      // Database
      try {
        const dbRes = await axios.get('https://sos911.onrender.com/api/db-status');
        diagnostics.push({ name: 'Database Connection', status: 'ok', detail: dbRes.data.message });
      } catch (err) {
        diagnostics.push({ name: 'Database Connection', status: 'fail', detail: err.message });
      }

      // Services
      try {
        const svcRes = await axios.get('https://sos911.onrender.com/api/services');
        diagnostics.push({ name: 'Services API', status: 'ok', detail: `${svcRes.data.length} services loaded` });
      } catch (err) {
        diagnostics.push({ name: 'Services API', status: 'fail', detail: err.message });
      }

      // Bookings
      try {
        const bkRes = await axios.get('https://sos911.onrender.com/api/bookings');
        diagnostics.push({ name: 'Bookings API', status: 'ok', detail: `${bkRes.data.length} bookings loaded` });
      } catch (err) {
        diagnostics.push({ name: 'Bookings API', status: 'fail', detail: err.message });
      }

      // Geolocation
      try {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true });
        });
        diagnostics.push({ name: 'Geolocation', status: 'ok', detail: `Lat: ${position.coords.latitude}, Lng: ${position.coords.longitude}` });
      } catch (err) {
        diagnostics.push({ name: 'Geolocation', status: 'fail', detail: err.message });
      }

      // QR code test
      try {
        const qrContainer = document.createElement('div');
        qrContainer.id = 'qrTest';
        await QRCode.toCanvas(qrContainer, 'TEST123', { width: 100 });
        diagnostics.push({ name: 'QR Code Generation', status: 'ok', detail: 'QR Generated', element: qrContainer });
      } catch (err) {
        diagnostics.push({ name: 'QR Code Generation', status: 'fail', detail: err.message });
      }

      // Render results
      diagContent.innerHTML = '';
      diagnostics.forEach(d => {
        const div = document.createElement('div');
        div.classList.add('diag-section');
        div.innerHTML = `<span class="diag-header">${d.name}:</span> 
          <span class="${d.status === 'ok' ? 'status-ok' : 'status-fail'}">${d.status === 'ok' ? 'OK' : 'FAIL'}</span>
          <div>${d.detail || ''}</div>`;
        if (d.element) div.appendChild(d.element);
        diagContent.appendChild(div);
      });
    });
  </script>
</body>
</html>