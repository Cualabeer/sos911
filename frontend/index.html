<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mechanic Customer Booking</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body{padding:0;margin:0;font-family:sans-serif;}
  #bookingForm{max-width:700px;margin:20px auto;padding:20px;border-radius:8px;box-shadow:0 0 10px #ccc;}
  footer{position:fixed;bottom:0;width:100%;background:#f8f9fa;padding:10px;text-align:center;}
  #ticketPopup{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:10px;z-index:10;box-shadow:0 0 20px #000;}
</style>
</head>
<body>

<div id="bookingForm" class="bg-light">
  <h2 class="text-center">Book Service</h2>
  <form id="form">
    <input type="number" id="customer_id" class="form-control my-2" placeholder="Customer ID" required>
    <select id="service_id" class="form-select my-2" required></select>
    <input type="text" id="lat" class="form-control my-2" placeholder="Latitude" readonly required>
    <input type="text" id="lng" class="form-control my-2" placeholder="Longitude" readonly required>
    <button type="submit" class="btn btn-primary w-100">Book</button>
  </form>
</div>

<div id="ticketPopup">
  <h3>Booking Ticket</h3>
  <img id="qrCode" src="" alt="QR Code" class="img-fluid">
  <button id="closeTicket" class="btn btn-secondary mt-2">Close</button>
</div>

<footer>
  <span id="dbStatus">Checking DB...</span>
</footer>

<script>
async function fetchServices(){
  const res = await fetch("/api/services");
  const data = await res.json();
  const sel = document.getElementById("service_id");
  data.forEach(s=>{let opt=document.createElement("option");opt.value=s.id;opt.text=s.name;sel.add(opt);});
}

async function checkDb(){
  const res = await fetch("/api/db-status");
  const data = await res.json();
  document.getElementById("dbStatus").innerText = data.status==="connected"?"✅ Database connected":"❌ DB connection failed";
}

function getLocation(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      document.getElementById("lat").value = pos.coords.latitude;
      document.getElementById("lng").value = pos.coords.longitude;
    });
  }
}

document.getElementById("form").onsubmit=async (e)=>{
  e.preventDefault();
  const cid=document.getElementById("customer_id").value;
  const sid=document.getElementById("service_id").value;
  const lat=document.getElementById("lat").value;
  const lng=document.getElementById("lng").value;

  const res = await fetch("/api/book",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({customer_id:cid, service_id:sid, lat, lng})
  });
  const data = await res.json();
  if(data.qr_code){
    document.getElementById("qrCode").src = data.qr_code;
    document.getElementById("ticketPopup").style.display = "block";
  }else{
    alert("Booking failed: "+data.error);
  }
};

document.getElementById("closeTicket").onclick=()=>document.getElementById("ticketPopup").style.display="none";

fetchServices();
checkDb();
getLocation();
</script>
</body>
</html>