<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile Mechanic Booking</title>
<style>
  :root {
    --golden: 1.618;
    --primary: #007BFF;
    --white: #ffffff;
    --spacing: 16px;
  }
  body {
    font-family: Arial, sans-serif;
    background: var(--white);
    color: #333;
    margin: var(--spacing);
  }
  h1 { margin-bottom: calc(var(--spacing) * var(--golden)); }
  form { display: flex; flex-direction: column; max-width: 480px; margin: auto; gap: calc(var(--spacing) * var(--golden)); }
  input, select, button { padding: var(--spacing); font-size: 1rem; border: 1px solid #ccc; border-radius: 6px; }
  button { background: var(--primary); color: white; border: none; cursor: pointer; }
  button:disabled { background: #aaa; }
  #dbStatus { margin-top: var(--spacing); text-align: center; font-weight: bold; }
  #ticketPopup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background:white; border: 2px solid #333; padding: calc(var(--spacing) * var(--golden)); z-index:100; max-width: 90%; }
  #ticketPopup pre { white-space: pre-wrap; font-family: monospace; }
</style>
</head>
<body>

<h1>Book Your Mobile Mechanic</h1>
<form id="bookingForm">
  <input type="text" id="name" name="name" placeholder="Full Name" required>
  <input type="email" id="email" name="email" placeholder="Email" required>
  <input type="text" id="phone" name="phone" placeholder="Phone (+44XXXXXXXXXX or 0XXXXXXXXXX)" required>
  <input type="text" id="vehicle" name="vehicle" placeholder="Vehicle Number Plate (UK)" required>
  <select id="service" name="service" required>
    <option value="">Select Service</option>
    <option>Oil Change</option>
    <option>Brake Repair</option>
    <option>Full Service</option>
    <option>Battery Replacement</option>
    <option>Tyre Change</option>
  </select>
  <input type="text" id="location" name="location" placeholder="Your Location" readonly required>
  <button type="submit" id="submitBtn" disabled>Book Now</button>
</form>

<div id="dbStatus">Checking DB...</div>

<div id="ticketPopup">
  <h2>Booking Ticket</h2>
  <pre id="ticketContent"></pre>
  <button onclick="closeTicket()">Close</button>
</div>

<script>
const poolStatusEl = document.getElementById('dbStatus');
const submitBtn = document.getElementById('submitBtn');
const locationInput = document.getElementById('location');

const ukPhoneRegex = /^(?:0|\+44)\d{10}$/;
const ukPlateRegex = /^[A-Z]{2}\d{2}\s?[A-Z]{3}$/i;

// Check backend DB connection
async function checkDb() {
  try {
    const res = await fetch('https://sos911.onrender.com/status');
    const json = await res.json();
    if(json.status === 'ok'){
      poolStatusEl.innerText = '✅ Database connected. Bookings working.';
    } else {
      poolStatusEl.innerText = '❌ Database not connected';
    }
  } catch(err){
    poolStatusEl.innerText = '❌ Database not connected';
  }
}
checkDb();

// Auto-location
navigator.geolocation.getCurrentPosition(async pos => {
  const { latitude, longitude } = pos.coords;
  // Reverse geocode with OpenStreetMap Nominatim free API
  const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`);
  const data = await resp.json();
  locationInput.value = data.display_name;
  submitBtn.disabled = false;
}, err => {
  locationInput.value = 'Unable to get location';
  submitBtn.disabled = true;
});

// Booking submission
document.getElementById('bookingForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  const email = document.getElementById('email').value.trim();
  const phone = document.getElementById('phone').value.trim();
  let vehicle = document.getElementById('vehicle').value.trim().toUpperCase().replace(/\s?/,' ');
  const service = document.getElementById('service').value;
  const location = locationInput.value;

  if(!name || !email || !phone || !vehicle || !service || !location){
    return alert('All fields are required');
  }
  if(!ukPhoneRegex.test(phone)) return alert('Invalid UK phone number');
  if(!ukPlateRegex.test(vehicle)) return alert('Invalid UK number plate');

  try{
    const res = await fetch('https://sos911.onrender.com/bookings', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({name,email,phone,vehicle,service,location})
    });
    const json = await res.json();
    if(json.error) return alert('Booking failed: '+json.error);
    
    // Show ticket popup
    document.getElementById('ticketContent').innerText = `
Booking ID: ${json.booking.id}
Customer: ${json.booking.customer_id}
Service: ${service}
Vehicle: ${vehicle}
Location: ${location}
QR: ${json.booking.qr_code}
Date: ${new Date(json.booking.created_at).toLocaleString()}
`;
    document.getElementById('ticketPopup').style.display = 'block';
  } catch(err){
    alert('Booking failed: '+err.message);
  }
});

function closeTicket(){
  document.getElementById('ticketPopup').style.display = 'none';
}
</script>
</body>
</html>