<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Book Mobile Mechanic</title>
<style>
html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; background: #f5f7fa; }
body { display: flex; flex-direction: column; }
header { background: #0077cc; color: white; text-align: center; padding: 1rem; flex: 0 0 auto; }
main { flex: 1 1 auto; display: flex; justify-content: center; align-items: center; }
form { width: 90%; max-width: 600px; background: white; padding: 2rem; border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 1rem;
      box-sizing: border-box; height: calc(100% - 4rem - 60px); } /* header + footer */
input, select, textarea, button { padding: 0.8rem; font-size: 1rem; border-radius: 5px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
textarea { resize: none; height: 80px; }
button { background: #0077cc; color: white; border: none; cursor: pointer; }
button:hover { background: #005fa3; }
footer { flex: 0 0 auto; background: #f1f1f1; text-align: center; padding: 1rem; font-size: 0.9rem; }
#ticket-popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: white; border-radius: 10px; padding: 2rem; max-width: 400px;
                box-shadow: 0 0 20px rgba(0,0,0,0.2); z-index: 1000; }
#ticket-popup.show { display: block; }
</style>
</head>
<body>
<header>
  <h1>Book a Mobile Mechanic</h1>
</header>

<main>
  <form id="booking-form">
    <input type="text" name="name" placeholder="Full Name" required>
    <input type="email" name="email" placeholder="Email" required>
    <input type="tel" name="phone" placeholder="Phone Number" required pattern="^[0-9+]{10,15}$" title="Enter a valid phone number">
    <input type="text" name="number_plate" placeholder="Vehicle Number Plate (UK)" required pattern="^[A-Z]{2}[0-9]{2}\s?[A-Z]{3}$" title="Enter a valid UK number plate (e.g., AB12 CDE)">
    <select name="service" required>
      <option value="">Select Service</option>
    </select>
    <input type="datetime-local" name="datetime" required>
    <textarea name="location" placeholder="Location" required></textarea>
    <button type="submit">Book Service</button>
  </form>
</main>

<div id="ticket-popup">
  <h2>Booking Ticket</h2>
  <p id="ticket-details"></p>
  <button onclick="document.getElementById('ticket-popup').classList.remove('show')">Close</button>
</div>

<footer>
  Database Status: <span id="db-status">Checking...</span>
</footer>

<script>
// Populate services
async function fetchServices() {
  try {
    const res = await fetch('/api/services');
    const data = await res.json();
    const select = document.querySelector('select[name="service"]');
    data.forEach(s => { const option = document.createElement('option'); option.value = s.id; option.textContent = s.name; select.appendChild(option); });
  } catch(e) { console.error('Error fetching services', e); }
}

// Check DB
async function checkDB() {
  try {
    const res = await fetch('/api/db-check');
    const data = await res.json();
    document.getElementById('db-status').innerText = data.connected ? "✅ Connected" : "❌ Not Connected";
  } catch(e) { document.getElementById('db-status').innerText = "❌ Not Connected"; }
}

// Form submit
document.getElementById('booking-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const payload = {};
  for (let [key, value] of formData.entries()) {
    if (key === 'number_plate') {
      value = value.toUpperCase().replace(/\s+/g,''); 
      if(value.length === 7) value = value.slice(0,4)+' '+value.slice(4);
      payload[key] = value;
      const regex = /^[A-Z]{2}[0-9]{2}\s?[A-Z]{3}$/;
      if(!regex.test(value)) { alert('Invalid UK number plate format'); return; }
    } else { payload[key] = value; }
  }
  try {
    const res = await fetch('/api/book', {
      method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(data.success){
      document.getElementById('ticket-details').innerText = 
        `Booking ID: ${data.id}\nService: ${data.service_id}\nDate: ${data.date_time}\nLocation: ${data.location}\nVehicle: ${data.number_plate}`;
      document.getElementById('ticket-popup').classList.add('show');
      e.target.reset();
    } else {
      alert('Booking failed: ' + data.error);
    }
  } catch(err){ alert('Booking failed: ' + err.message); }
});

fetchServices();
checkDB();
</script>
</body>
</html>