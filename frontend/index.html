<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Customer Booking</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  html, body { height: 100%; margin:0; font-family: Arial, sans-serif; }
  .container { max-width: 900px; margin: auto; padding: 2rem; }
  .footer { position: fixed; bottom: 0; width: 100%; background: #f8f9fa; padding: 0.5rem; text-align: center; z-index: 100; }
  .form-control { margin-bottom: 1rem; }
  #ticketModal .modal-content { text-align:center; }
</style>
</head>
<body>

<div class="container">
  <h1 class="mb-4 text-center">Book a Service</h1>
  <form id="bookingForm">
    <input type="text" id="name" class="form-control" placeholder="Full Name" required>
    <input type="email" id="email" class="form-control" placeholder="Email (UK format)" required>
    <input type="text" id="phone" class="form-control" placeholder="Phone (UK)" required pattern="^(\+44\s?7\d{3}|\(?07\d{3}\)?)\s?\d{3}\s?\d{3}$">
    <input type="text" id="numberPlate" class="form-control" placeholder="Number Plate (UK)" required pattern="^[A-Z]{2}\d{2}\s?[A-Z]{3}$">
    <input type="text" id="address" class="form-control" placeholder="Address" required>
    <input type="hidden" id="latitude">
    <input type="hidden" id="longitude">

    <select id="serviceSelect" class="form-control" required>
      <option value="">Select Service</option>
      <option value="1">Oil Change</option>
      <option value="2">Brake Inspection</option>
      <option value="3">Battery Replacement</option>
    </select>
    <button type="submit" class="btn btn-primary w-100">Book Service</button>
  </form>
</div>

<div class="footer">
  <span id="dbStatus">Database: Checking...</span>
  <button id="diagnoseBtn" class="btn btn-sm btn-outline-secondary ms-2">Run Diagnostics</button>
</div>

<!-- Ticket Modal -->
<div class="modal fade" id="ticketModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <h5>Your Booking Ticket</h5>
      <p id="ticketInfo"></p>
      <canvas id="qrCanvas"></canvas>
      <button type="button" class="btn btn-success mt-2" data-bs-dismiss="modal">Close</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
  const form = document.getElementById('bookingForm');
  const numberPlate = document.getElementById('numberPlate');
  const dbStatus = document.getElementById('dbStatus');
  const diagnoseBtn = document.getElementById('diagnoseBtn');
  const latitudeInput = document.getElementById('latitude');
  const longitudeInput = document.getElementById('longitude');
  const addressInput = document.getElementById('address');
  const ticketModal = new bootstrap.Modal(document.getElementById('ticketModal'));
  const ticketInfo = document.getElementById('ticketInfo');
  const qrCanvas = document.getElementById('qrCanvas');

  // Auto uppercase & format UK number plate
  numberPlate.addEventListener('input', e => {
    let val = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,'');
    if(val.length >= 4) val = val.slice(0,4) + ' ' + val.slice(4);
    e.target.value = val;
  });

  // Auto-detect location
  window.onload = () => {
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos => {
        latitudeInput.value = pos.coords.latitude;
        longitudeInput.value = pos.coords.longitude;
        reverseGeocode(pos.coords.latitude, pos.coords.longitude);
      });
    }
    checkDbStatus();
  };

  // Reverse geocode using Nominatim
  async function reverseGeocode(lat, lng){
    try{
      const res = await axios.get(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
      if(res.data && res.data.display_name) addressInput.value = res.data.display_name;
    }catch(e){
      console.error('Reverse geocode failed', e);
    }
  }

  // Submit booking
  form.addEventListener('submit', async e => {
    e.preventDefault();
    const data = {
      name: document.getElementById('name').value,
      email: document.getElementById('email').value,
      phone: document.getElementById('phone').value,
      number_plate: numberPlate.value,
      address: addressInput.value,
      latitude: latitudeInput.value,
      longitude: longitudeInput.value,
      service_id: document.getElementById('serviceSelect').value
    };
    try{
      const res = await axios.post('/api/bookings', data);
      ticketInfo.textContent = `Booking ID: ${res.data.id}\nService: ${document.getElementById('serviceSelect').selectedOptions[0].text}`;
      QRCode.toCanvas(qrCanvas, `Booking:${res.data.id}`, { width:150 });
      ticketModal.show();
    }catch(err){
      alert('Booking failed: '+(err.response?.data?.error||err.message));
    }
  });

  // Diagnostics
  diagnoseBtn.addEventListener('click', async () => {
    try{
      const res = await axios.get('/api/diagnostics');
      alert(`Diagnostics:
DB: ${res.data.db}
Services loaded: ${res.data.servicesCount}
Bookings loaded: ${res.data.bookingsCount}
QR: ${res.data.qr}`);
    }catch(err){
      alert('Diagnostics failed: '+err.message);
    }
  });

  // Check DB status for footer
  async function checkDbStatus(){
    try{
      const res = await axios.get('/api/diagnostics');
      dbStatus.textContent = `Database: ${res.data.db} | Services: ${res.data.servicesCount} | Bookings: ${res.data.bookingsCount}`;
    }catch{
      dbStatus.textContent = 'Database: ‚ùå Not Connected';
    }
  }
</script>
</body>
</html>