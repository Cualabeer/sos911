<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SOS Mechanics - Customer Booking</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #ffffff;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  header {
    width: 100%;
    background: #0057b7;
    color: white;
    padding: 1.618rem 0; /* golden ratio spacing */
    text-align: center;
    font-size: 2rem;
  }
  main {
    max-width: 600px;
    width: 90%;
    margin: 2rem auto;
    display: flex;
    flex-direction: column;
    gap: 1.618rem;
  }
  input, select, button {
    padding: 0.618rem 1rem; /* golden ratio */
    font-size: 1rem;
    width: 100%;
    box-sizing: border-box;
  }
  button {
    background: #0057b7;
    color: white;
    border: none;
    cursor: pointer;
    font-weight: bold;
  }
  button:hover {
    background: #004096;
  }
  .confirmation {
    background: #f0f8ff;
    padding: 1.618rem;
    border-radius: 0.618rem;
    text-align: center;
    display: none;
    flex-direction: column;
    gap: 0.618rem;
  }
  .qr-code {
    font-weight: bold;
    font-size: 1.2rem;
    color: #333;
  }
</style>
</head>
<body>

<header>SOS Mechanics - Book a Service</header>

<main>
  <form id="bookingForm">
    <input type="text" id="customer_name" placeholder="Your Name" required>
    <input type="text" id="vehicle_reg" placeholder="Vehicle Registration" required>
    <select id="service_name" required>
      <option value="">Select Service</option>
      <option value="Oil Change">Oil Change</option>
      <option value="Brake Check">Brake Check</option>
      <option value="Battery Replacement">Battery Replacement</option>
      <option value="Tire Replacement">Tire Replacement</option>
      <option value="Full Service">Full Service</option>
    </select>
    <input type="text" id="location" placeholder="Your Location" required>
    <button type="submit">Book Service</button>
  </form>

  <div class="confirmation" id="confirmation">
    <p>âœ… Booking Confirmed!</p>
    <p>Your QR code: <span class="qr-code" id="qrCode"></span></p>
    <p>Show this QR code to the mechanic.</p>
  </div>
</main>

<script>
const form = document.getElementById('bookingForm');
const confirmation = document.getElementById('confirmation');
const qrCodeEl = document.getElementById('qrCode');
const locationInput = document.getElementById('location');

// Auto-detect location
if(navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(async (pos) => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    // Free reverse geocode via OpenStreetMap Nominatim
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
    const data = await res.json();
    locationInput.value = data.display_name || '';
  }, (err) => {
    console.warn('Location access denied:', err);
  });
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();

  const booking = {
    customer_name: document.getElementById('customer_name').value.trim(),
    vehicle_reg: formatReg(document.getElementById('vehicle_reg').value.trim()),
    service_name: document.getElementById('service_name').value,
    location: document.getElementById('location').value.trim()
  };

  try {
    const res = await fetch('/bookings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(booking)
    });
    const data = await res.json();
    if(data.qr_code) {
      qrCodeEl.textContent = data.qr_code;
      confirmation.style.display = 'flex';
      form.reset();
    } else {
      alert('Booking failed');
    }
  } catch(err) {
    console.error(err);
    alert('Error connecting to server');
  }
});

// Format vehicle registration in uppercase with space
function formatReg(reg) {
  reg = reg.toUpperCase().replace(/\s+/g,'');
  // UK style: 2-2-3 pattern (example: AB12 CDE)
  if(reg.length === 7) {
    return reg.slice(0,2)+' '+reg.slice(2,4)+' '+reg.slice(4);
  }
  return reg;
}
</script>

</body>
</html>