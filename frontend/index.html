<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile Mechanic Booking</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body{font-family:Arial,sans-serif;background:#f9f9f9;margin:0;padding:0;}
.container{max-width:700px;margin:40px auto;padding:30px;background:#fff;border-radius:12px;box-shadow:0 0 20px rgba(0,0,0,0.08);}
h1{text-align:center;margin-bottom:30px;color:#007BFF;}
.form-control:focus{box-shadow:none;border-color:#007BFF;}
footer{margin-top:20px;text-align:center;font-size:.85rem;color:#555;}
#diagnosticPopup{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:9999;}
#diagnosticPopup .content{background:#fff;padding:20px;border-radius:10px;max-width:400px;width:90%;max-height:80%;overflow-y:auto;}
#qrModal .modal-body img{width:100%;}
.map-container{height:200px;margin-bottom:15px;}
</style>
</head>
<body>
<div class="container">
<h1>Book a Service</h1>
<form id="bookingForm">
  <div class="mb-3"><label for="name">Full Name</label><input type="text" id="name" class="form-control" required></div>
  <div class="mb-3"><label for="email">Email</label><input type="email" id="email" class="form-control" required></div>
  <div class="mb-3"><label for="phone">Phone Number</label><input type="tel" id="phone" class="form-control" required placeholder="07123 456789"></div>
  <div class="mb-3"><label for="regNumber">UK Registration Plate</label><input type="text" id="regNumber" class="form-control" required placeholder="AB12 CDE"></div>
  <div class="mb-3">
    <label for="service">Service</label>
    <select id="service" class="form-select" required></select>
  </div>
  <div class="mb-3"><label for="serviceDate">Service Date</label><input type="date" id="serviceDate" class="form-control" required></div>
  <div class="mb-3">
    <label>Location</label>
    <div class="map-container" id="map"></div>
    <input type="hidden" id="lat">
    <input type="hidden" id="lng">
    <input type="text" id="address" class="form-control" placeholder="Confirm Address" required>
  </div>
  <button type="submit" class="btn btn-primary w-100">Book Service</button>
</form>
</div>

<footer>
<span id="dbStatus">Checking database...</span>
<button class="btn btn-link" id="diagnosticBtn">Run Diagnostics</button>
</footer>

<!-- QR Code Modal -->
<div class="modal fade" id="qrModal" tabindex="-1">
<div class="modal-dialog"><div class="modal-content">
<div class="modal-header"><h5 class="modal-title">Booking Confirmed</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
<div class="modal-body"><p>Show this QR to the mechanic or screenshot for reference.</p><img id="qrImg" src=""></div></div></div></div>

<!-- Diagnostic Popup -->
<div id="diagnosticPopup">
<div class="content">
<h5>System Diagnostics</h5>
<ul id="diagnosticList"></ul>
<button class="btn btn-secondary mt-3" id="closeDiag">Close</button>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.5/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.5/dist/leaflet.css" />

<script>
let map, marker;

async function initMap() {
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat = pos.coords.latitude, lng = pos.coords.longitude;
      document.getElementById('lat').value=lat;
      document.getElementById('lng').value=lng;
      map = L.map('map').setView([lat,lng],15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
      marker=L.marker([lat,lng],{draggable:true}).addTo(map);
      marker.on('dragend',()=>{const p=marker.getLatLng();document.getElementById('lat').value=p.lat;document.getElementById('lng').value=p.lng;});
      fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
      .then(r=>r.json()).then(d=>document.getElementById('address').value=d.display_name);
    });
  }
}

async function fetchServices() {
  try{
    const res = await fetch('/api/services');
    const data = await res.json();
    const serviceSelect = document.getElementById('service');
    data.forEach(s=>{const opt=document.createElement('option');opt.value=s.id;opt.textContent=s.name;serviceSelect.appendChild(opt);});
  }catch(err){console.error(err);}
}

async function checkDb(){
  try{
    const res = await fetch('/api/db-status');
    const data = await res.json();
    document.getElementById('dbStatus').textContent=`Database: ${data.db}, Services: ${data.services}, Bookings: ${data.bookings}`;
  }catch(err){document.getElementById('dbStatus').textContent='Database: Error';}
}

document.addEventListener('DOMContentLoaded',()=>{
  initMap(); fetchServices(); checkDb();

  document.getElementById('bookingForm').addEventListener('submit',async(e)=>{
    e.preventDefault();
    const name=document.getElementById('name').value.trim();
    const email=document.getElementById('email').value.trim();
    const phone=document.getElementById('phone').value.trim();
    let reg=document.getElementById('regNumber').value.toUpperCase().replace(/\s+/g,'');
    const service_id=document.getElementById('service').value;
    const service_date=document.getElementById('serviceDate').value;
    const lat=document.getElementById('lat').value;
    const lng=document.getElementById('lng').value;
    const address=document.getElementById('address').value;

    if(!/^[A-Z]{2}[0-9]{2}[A-Z]{3}$/.test(reg.replace(/\s+/g,''))){alert('Invalid UK registration plate');return;}
    reg=reg.slice(0,2)+reg.slice(2,4)+' '+reg.slice(4);

    try{
      const regRes=await fetch('/api/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,email,phone,password:'temp123'})});
      await regRes.json();
      const bookRes=await fetch('/api/bookings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({customer_id:1,service_id,reg_number:reg,service_date,lat,lng,address})});
      const bookData=await bookRes.json();
      if(bookData.qr_code){const qrModal=new bootstrap.Modal(document.getElementById('qrModal'));document.getElementById('qrImg').src=bookData.qr_code;qrModal.show();}
      else alert('Booking failed: '+bookData.error);
    }catch(err){alert('Booking failed: '+err.message);}
  });

  const diagBtn=document.getElementById('diagnosticBtn');
  const diagPopup=document.getElementById('diagnosticPopup');
  const closeDiag=document.getElementById('closeDiag');
  diagBtn.addEventListener('click',async()=>{
    diagPopup.style.display='flex';
    const list=document.getElementById('diagnosticList'); list.innerHTML='';
    const checks=[{name:'Database',url:'/api/db-status'},{name:'Services API',url:'/api/services'},{name:'Bookings API',url:'/api/bookings'}];
    for(const c of checks){try{await fetch(c.url); list.innerHTML+=`<li>${c.name}: ✅ OK</li>`;}catch(e){list.innerHTML+=`<li>${c.name}: ❌ FAIL</li>`;}}
  });
  closeDiag.addEventListener('click',()=>{diagPopup.style.display='none';});
});
</script>
</body>
</html>