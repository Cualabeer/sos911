<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile Mechanic Booking</title>
<style>
  body { margin:0; font-family:sans-serif; background:#f5f5f5; }
  header { background:#111; color:#fff; padding:1rem; display:flex; justify-content:space-between; align-items:center; }
  header h1 { margin:0; font-size:1.5rem; }
  header button { padding:.5rem 1rem; margin-left:.5rem; background:#ff6600; border:none; color:#fff; cursor:pointer; }
  .carousel { display:flex; overflow-x:auto; gap:1rem; padding:1rem; scroll-snap-type:x mandatory; }
  .service-card { background:#fff; border-radius:8px; padding:1rem; min-width:250px; scroll-snap-align:start; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
  .service-card h3 { margin-top:0; }
  .modal-bg { position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:1000;}
  .modal { background:#fff; padding:1rem; border-radius:8px; max-width:400px; width:90%; position:relative;}
  .close { position:absolute; top:.5rem; right:.5rem; cursor:pointer; font-size:1.2rem;}
  footer { position:fixed; bottom:0; left:0; width:100%; background:#111; color:#fff; padding:.5rem 1rem; cursor:pointer;}
  .footer-panel { position:fixed; bottom:0; left:0; width:100%; height:75%; background:#222; color:#fff; transform:translateY(100%); transition:.3s; padding:1rem; overflow:auto; z-index:1000;}
  button.book { background:#28a745; color:#fff; border:none; padding:.5rem 1rem; cursor:pointer; border-radius:4px; }
</style>
</head>
<body>

<header>
  <h1>Mobile Mechanic</h1>
  <div>
    <button id="loginBtn">Login</button>
    <button id="registerBtn">Register</button>
  </div>
</header>

<section class="carousel" id="serviceCarousel">
  <!-- Services will be populated here -->
</section>

<!-- Booking Modal -->
<div class="modal-bg" id="bookingModal">
  <div class="modal">
    <span class="close" id="closeBooking">&times;</span>
    <h2>Book a Service</h2>
    <form id="bookingForm">
      <label for="customerId">Customer ID:</label>
      <input type="number" id="customerId" required><br><br>
      <label for="serviceId">Service:</label>
      <select id="serviceId" required></select><br><br>
      <label for="location">Location:</label>
      <input type="text" id="location" required><br><br>
      <label for="postcode">Postcode:</label>
      <input type="text" id="postcode" required><br><br>
      <button type="submit" class="book">Book Now</button>
    </form>
  </div>
</div>

<!-- Login Modal -->
<div class="modal-bg" id="loginModal">
  <div class="modal">
    <span class="close" id="closeLogin">&times;</span>
    <h2>Login</h2>
    <form id="loginForm">
      <label>Email:</label>
      <input type="email" id="loginEmail" required><br><br>
      <label>Password:</label>
      <input type="password" id="loginPassword" required><br><br>
      <button type="submit">Login</button>
    </form>
  </div>
</div>

<!-- Register Modal -->
<div class="modal-bg" id="registerModal">
  <div class="modal">
    <span class="close" id="closeRegister">&times;</span>
    <h2>Register</h2>
    <form id="registerForm">
      <label>Name:</label><input type="text" id="regName" required><br><br>
      <label>Email:</label><input type="email" id="regEmail" required><br><br>
      <label>Phone:</label><input type="text" id="regPhone" required><br><br>
      <label>Reg Plate:</label><input type="text" id="regPlate" required><br><br>
      <label>Address:</label><input type="text" id="regAddress" required><br><br>
      <button type="submit">Register</button>
    </form>
  </div>
</div>

<footer id="footerDiag">Diagnostics - Click to Open</footer>
<div class="footer-panel" id="diagPanel"></div>

<script>
async function fetchServices() {
  const res = await fetch("/api/services");
  const services = await res.json();
  const carousel = document.getElementById("serviceCarousel");
  services.forEach(s => {
    const card = document.createElement("div");
    card.className="service-card";
    card.innerHTML=`<h3>${s.name}</h3><p>${s.description}</p><button class="book" onclick="openBooking(${s.id})">Book</button>`;
    carousel.appendChild(card);
  });

  const select = document.getElementById("serviceId");
  services.forEach(s=>{
    const opt = document.createElement("option");
    opt.value=s.id; opt.textContent=s.name;
    select.appendChild(opt);
  });
}

function openBooking(serviceId){
  document.getElementById("serviceId").value=serviceId;
  document.getElementById("bookingModal").style.display="flex";
}

// Modals
document.getElementById("loginBtn").onclick=()=>document.getElementById("loginModal").style.display="flex";
document.getElementById("registerBtn").onclick=()=>document.getElementById("registerModal").style.display="flex";
document.getElementById("closeLogin").onclick=()=>document.getElementById("loginModal").style.display="none";
document.getElementById("closeRegister").onclick=()=>document.getElementById("registerModal").style.display="none";
document.getElementById("closeBooking").onclick=()=>document.getElementById("bookingModal").style.display="none";

// Booking submit
document.getElementById("bookingForm").onsubmit=async(e)=>{
  e.preventDefault();
  const data={
    customer_id:document.getElementById("customerId").value,
    service_id:document.getElementById("serviceId").value,
    location:document.getElementById("location").value,
    postcode:document.getElementById("postcode").value
  };
  const res=await fetch("/api/bookings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});
  const result=await res.json();
  if(result.qr_code){
    alert("Booked! QR generated.");
    document.getElementById("bookingModal").style.display="none";
  }else{
    alert("Error: "+result.error);
  }
};

// Footer diagnostics
const diagPanel=document.getElementById("diagPanel");
document.getElementById("footerDiag").onclick=async()=>{
  const res=await fetch("/api/diagnostics");
  const diag=await res.json();
  diagPanel.innerHTML=JSON.stringify(diag,null,2);
  diagPanel.style.transform="translateY(0)";
};
diagPanel.onclick=()=>diagPanel.style.transform="translateY(100%)";

fetchServices();
</script>

</body>
</html>