<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Book a Service</title>
<link rel="stylesheet" href="styles.css">
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
  header { background: #1e90ff; color: white; padding: 20px; text-align: center; }
  main { padding: 20px; max-width: 800px; margin: auto; }
  form { display: flex; flex-direction: column; gap: 15px; background: white; padding: 20px; border-radius: 10px; }
  input, select, button { padding: 10px; font-size: 1em; border-radius: 5px; border: 1px solid #ccc; }
  button { background: #1e90ff; color: white; border: none; cursor: pointer; }
  button:hover { background: #0073e6; }
  footer { background: #f1f1f1; padding: 15px; text-align: center; font-size: 0.9em; color: #333; }
  .status { display: inline-block; margin: 0 5px; font-weight: bold; }
  .ok { color: green; }
  .fail { color: red; }
</style>
</head>
<body>

<header>
  <h1>Book a Mobile Mechanic Service</h1>
</header>

<main>
  <form id="bookingForm">
    <input type="text" id="name" placeholder="Full Name" required>
    <input type="text" id="phone" placeholder="Phone Number" required>
    <input type="text" id="numberPlate" placeholder="Number Plate (UK)" required>
    <select id="service" required>
      <option value="">Select a Service</option>
      <option value="oil-change">Oil Change</option>
      <option value="brake-repair">Brake Repair</option>
      <option value="battery-replacement">Battery Replacement</option>
    </select>
    <input type="datetime-local" id="datetime" required>
    <button type="submit">Book Service</button>
  </form>
</main>

<footer>
  Database: <span id="dbStatus" class="status">Checking...</span>
  Services: <span id="servicesStatus" class="status">Checking...</span>
  Bookings: <span id="bookingsStatus" class="status">Checking...</span>
  <div id="last-checked"></div>
</footer>

<script>
async function checkApi(url) {
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    return { success: true, data };
  } catch (err) {
    return { success: false, error: err.message };
  }
}

async function updateDiagnostics() {
  // Database
  const db = await checkApi('/api/db-status');
  const dbSpan = document.getElementById('dbStatus');
  dbSpan.textContent = db.success ? '✅ Connected' : `❌ ${db.error}`;
  dbSpan.className = `status ${db.success ? 'ok' : 'fail'}`;

  // Services
  const services = await checkApi('/api/services');
  const svcSpan = document.getElementById('servicesStatus');
  svcSpan.textContent = services.success ? `✅ ${services.data.length} found` : `❌ ${services.error}`;
  svcSpan.className = `status ${services.success ? 'ok' : 'fail'}`;

  // Bookings
  const bookings = await checkApi('/api/bookings');
  const bookSpan = document.getElementById('bookingsStatus');
  bookSpan.textContent = bookings.success ? `✅ ${bookings.data.length} found` : `❌ ${bookings.error}`;
  bookSpan.className = `status ${bookings.success ? 'ok' : 'fail'}`;

  const now = new Date();
  document.getElementById('last-checked').textContent = `Last Checked: ${now.toLocaleString()}`;
}

// Run diagnostics every 30 seconds
updateDiagnostics();
setInterval(updateDiagnostics, 30000);

// Auto-format UK number plate
const plateInput = document.getElementById('numberPlate');
plateInput.addEventListener('input', () => {
  plateInput.value = plateInput.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
});

// Booking submission
document.getElementById('bookingForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const payload = {
    name: document.getElementById('name').value,
    phone: document.getElementById('phone').value,
    numberPlate: document.getElementById('numberPlate').value,
    service: document.getElementById('service').value,
    datetime: document.getElementById('datetime').value,
  };

  try {
    const res = await fetch('/api/bookings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (res.ok) {
      alert('Booking Successful! Ticket generated.');
      console.log(data);
    } else {
      alert('Booking Failed: ' + data.error);
    }
  } catch(err) {
    alert('Booking Failed: ' + err.message);
  }
});
</script>

</body>
</html>