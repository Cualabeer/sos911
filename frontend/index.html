<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Book a Mobile Mechanic</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: auto;
      padding: 20px;
      line-height: 1.6;
      background: #fdfdfd;
    }
    h1 { text-align:center; color:#007bff; }
    form { display: flex; flex-direction: column; gap: 15px; background:white; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    label { font-weight: bold; }
    input, select { padding: 10px; font-size: 1rem; width:100%; box-sizing:border-box; }
    button { padding: 12px; font-size:1rem; background:#007bff; color:white; border:none; border-radius:5px; cursor:pointer; }
    button:hover { background:#0056b3; }
    #footer { text-align:center; margin-top:20px; color:gray; }
    #ticket { display:none; padding:20px; border:2px solid #007bff; margin-top:20px; }
  </style>
</head>
<body>

<h1>Book a Mobile Mechanic</h1>

<form id="bookingForm">
  <label>Name:</label>
  <input type="text" id="name" required>

  <label>Phone:</label>
  <input type="text" id="phone" required>

  <label>Email:</label>
  <input type="email" id="email" required>

  <label>Service:</label>
  <select id="service" required></select>

  <label>Date & Time:</label>
  <input type="datetime-local" id="datetime" required>

  <label>Location:</label>
  <input type="text" id="location" required placeholder="Allow location or type manually">

  <label>Number Plate:</label>
  <input type="text" id="plate" placeholder="AB12 CDE" required>

  <button type="submit">Book Service</button>
</form>

<div id="ticket"></div>

<div id="footer">Checking database...</div>

<script>
async function checkDb() {
  try {
    const res = await fetch('/api/status');
    const data = await res.json();
    document.getElementById('footer').textContent = data.status;
  } catch(e) {
    document.getElementById('footer').textContent = '❌ Database not connected';
  }
}
checkDb();

async function loadServices() {
  try {
    const res = await fetch('/api/services');
    const services = await res.json();
    const sel = document.getElementById('service');
    services.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = `${s.name} (£${s.price})`;
      sel.appendChild(opt);
    });
  } catch(e) {
    console.error(e);
  }
}
loadServices();

document.getElementById('bookingForm').addEventListener('submit', async e => {
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const email = document.getElementById('email').value.trim();
  const service = document.getElementById('service').value;
  const datetime = document.getElementById('datetime').value;
  const location = document.getElementById('location').value.trim();
  let plate = document.getElementById('plate').value.toUpperCase().replace(/\s+/g,'');
  
  if(!/^([A-Z]{2}[0-9]{2}[A-Z]{3})$/.test(plate)) {
    alert('Number plate must be in UK format AB12CDE');
    return;
  }
  
  try {
    const res = await fetch('/api/book', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({name,phone,email,service,datetime,location,plate})
    });
    const data = await res.json();
    if(data.success) {
      const ticketDiv = document.getElementById('ticket');
      ticketDiv.style.display='block';
      ticketDiv.innerHTML = `<h2>Booking Confirmed</h2>
        <p>Service: ${data.service}</p>
        <p>Date & Time: ${data.datetime}</p>
        <p>Location: ${data.location}</p>
        <p>Number Plate: ${data.plate}</p>`;
    } else {
      alert('Booking failed: '+data.error);
    }
  } catch(e) {
    console.error(e);
  }
});
</script>

</body>
</html>