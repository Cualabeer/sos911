<!-- frontend/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile Mechanic Booking</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { font-family: Arial, sans-serif; background:#f8f9fa; margin:0; padding:0;}
  .container { max-width: 700px; margin: 30px auto; background: #fff; padding: 30px; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,0.1);}
  h1 { text-align:center; margin-bottom:20px; }
  .form-control { margin-bottom:15px; }
  footer { text-align:center; padding:15px; font-size:0.9em; color:#555; }
  #diagnostics { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); color:#fff; z-index:1000; overflow-y:auto; padding:20px; }
  #diagnostics pre { white-space:pre-wrap; word-break:break-word; }
  #diagClose { position:absolute; top:10px; right:20px; cursor:pointer; font-size:1.5em; }
</style>
</head>
<body>
<div class="container">
  <h1>Book Your Service</h1>
  <form id="bookingForm">
    <input type="text" class="form-control" id="name" placeholder="Full Name" required>
    <input type="email" class="form-control" id="email" placeholder="Email" required>
    <input type="tel" class="form-control" id="phone" placeholder="UK Phone Number" pattern="^07[0-9]{9}$" required>
    <input type="text" class="form-control" id="numberPlate" placeholder="Vehicle Registration (UK)" pattern="^[A-Z]{2}[0-9]{2} [A-Z]{3}$" required>
    <input type="text" class="form-control" id="address" placeholder="Address" required>
    <input type="hidden" id="latitude">
    <input type="hidden" id="longitude">
    <select class="form-control" id="serviceSelect" required></select>
    <button type="submit" class="btn btn-primary w-100">Book Service</button>
  </form>
</div>

<footer>
  <span id="dbStatus">Database: checking...</span>
  <button class="btn btn-sm btn-light" onclick="showDiagnostics()">Run Diagnostics</button>
</footer>

<div id="diagnostics">
  <span id="diagClose" onclick="closeDiagnostics()">✖</span>
  <h3>System Diagnostics</h3>
  <pre id="diagOutput"></pre>
</div>

<script>
async function fetchServices() {
  try {
    const res = await fetch('/api/services');
    const services = await res.json();
    const sel = document.getElementById('serviceSelect');
    services.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = `${s.name} (${s.category})`;
      sel.appendChild(opt);
    });
  } catch(e) { console.error(e); }
}

async function checkDb() {
  try {
    const res = await fetch('/api/db-status');
    const status = await res.json();
    document.getElementById('dbStatus').textContent = status.status==='connected'? 'Database: ✅ connected':'Database: ❌ error';
  } catch(e) {
    document.getElementById('dbStatus').textContent = 'Database: ❌ error';
  }
}

function formatNumberPlate(e) {
  let val = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,'');
  if(val.length>4) val = val.slice(0,4)+' '+val.slice(4,7);
  e.target.value = val;
}

async function geolocate() {
  if(navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      document.getElementById('latitude').value = pos.coords.latitude;
      document.getElementById('longitude').value = pos.coords.longitude;
      reverseGeocode(pos.coords.latitude, pos.coords.longitude);
    });
  }
}

async function reverseGeocode(lat,lng){
  try{
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
    const data = await res.json();
    document.getElementById('address').value = data.display_name || '';
  }catch(e){ console.error(e);}
}

document.getElementById('numberPlate').addEventListener('input', formatNumberPlate);

document.getElementById('bookingForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const payload = {
    customer_id:1, // for demo purposes, replace with real login
    service_id: document.getElementById('serviceSelect').value,
    number_plate: document.getElementById('numberPlate').value,
    address: document.getElementById('address').value,
    latitude: document.getElementById('latitude').value,
    longitude: document.getElementById('longitude').value
  };
  try{
    const res = await fetch('/api/bookings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const data = await res.json();
    if(data.bookingId){
      alert('Booking confirmed! QR code ready.');
    } else alert('Booking failed: '+(data.error||'Unknown error'));
  }catch(err){ alert('Booking failed: '+err.message); }
});

async function showDiagnostics(){
  const output = document.getElementById('diagOutput');
  output.textContent = 'Running diagnostics...\n';
  document.getElementById('diagnostics').style.display='block';

  try{
    const db = await fetch('/api/db-status').then(r=>r.json());
    output.textContent += `Database: ${db.status==='connected'?'✅ connected':'❌ error'}\n`;
    const services = await fetch('/api/services').then(r=>r.json());
    output.textContent += `Services API: ${services.length} services loaded\n`;
    const bookings = await fetch('/api/bookings').then(r=>r.json());
    output.textContent += `Bookings API: ${bookings.length} bookings loaded\n`;
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        output.textContent += `Geolocation: Lat ${pos.coords.latitude}, Lng ${pos.coords.longitude}\n`;
      });
    }else output.textContent += 'Geolocation: ❌ not available\n';
  }catch(e){ output.textContent += 'Diagnostics error: '+e.message+'\n'; }
}

function closeDiagnostics(){ document.getElementById('diagnostics').style.display='none'; }

window.onload = ()=>{
  fetchServices();
  checkDb();
  geolocate();
}
</script>
</body>
</html>