<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile Mechanic</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body {padding-top: 70px;}
  .carousel-item {height: 250px; background-size: cover; background-position: center;}
  #profileMenu {position: fixed; top: 70px; right: 0; width: 300px; max-height: 80%; overflow-y: auto; background: #f8f9fa; border-left: 1px solid #ccc; padding: 15px; display: none;}
  .modal-lg {max-width: 90%;}
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">SOS Mechanics</a>
    <button class="btn btn-outline-light" id="loginBtn">Login / Register</button>
  </div>
</nav>

<!-- Hero -->
<header class="bg-primary text-white text-center py-5">
  <h1>Your Mobile Mechanic</h1>
  <p>Quick, Reliable, On-Demand Vehicle Services</p>
</header>

<!-- Services Carousel -->
<div id="servicesCarousel" class="carousel slide container mt-4" data-bs-ride="carousel">
  <div class="carousel-inner" id="servicesInner"></div>
  <button class="carousel-control-prev" type="button" data-bs-target="#servicesCarousel" data-bs-slide="prev">
    <span class="carousel-control-prev-icon"></span>
  </button>
  <button class="carousel-control-next" type="button" data-bs-target="#servicesCarousel" data-bs-slide="next">
    <span class="carousel-control-next-icon"></span>
  </button>
</div>

<!-- Quote / Callout Estimation -->
<section class="container mt-5">
  <h3>Get a Quick Quote</h3>
  <form id="quoteForm" class="row g-3">
    <div class="col-md-4">
      <input type="text" id="quoteService" class="form-control" placeholder="Service Name" required>
    </div>
    <div class="col-md-4">
      <input type="text" id="quoteCallout" class="form-control" placeholder="Postcode" required>
    </div>
    <div class="col-md-4">
      <button class="btn btn-success w-100" type="submit">Estimate</button>
    </div>
  </form>
  <div id="quoteResult" class="mt-3"></div>
</section>

<!-- FAQ -->
<section class="container mt-5">
  <h3>Frequently Asked Questions</h3>
  <div class="accordion" id="faqAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">How quickly can a mechanic arrive?</button></h2>
      <div id="faq1" class="accordion-collapse collapse show">
        <div class="accordion-body">Within 60 minutes for urgent requests.</div>
      </div>
    </div>
    <div class="accordion-item">
      <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">Do you offer warranty on parts?</button></h2>
      <div id="faq2" class="accordion-collapse collapse">
        <div class="accordion-body">Yes, all parts come with a 12-month warranty.</div>
      </div>
    </div>
  </div>
</section>

<!-- Customer Dashboard -->
<div id="profileMenu">
  <h5>Profile</h5>
  <div id="loyaltyPoints" class="mb-2"></div>
  <h6>Your Cars</h6>
  <ul id="carList"></ul>
  <button class="btn btn-secondary mb-2 w-100" id="addCarBtn">Add Car</button>
  <h6>Booking History</h6>
  <ul id="bookingHistory"></ul>
  <button class="btn btn-danger w-100" id="logoutBtn">Logout</button>
</div>

<!-- Login/Register Modal -->
<div class="modal fade" id="authModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content p-3">
      <h5 id="authTitle">Login</h5>
      <form id="authForm">
        <div class="mb-2">
          <label>Email</label>
          <input type="email" id="authEmail" class="form-control" required>
        </div>
        <div class="mb-2">
          <label>Password</label>
          <input type="password" id="authPassword" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary w-100">Submit</button>
      </form>
      <p class="mt-2 text-center">
        <a href="#" id="toggleAuth">Switch to Register</a>
      </p>
      <div id="authResult" class="mt-2"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let loggedInCustomer = null;
const authModal = new bootstrap.Modal(document.getElementById('authModal'));
document.getElementById('loginBtn').addEventListener('click',()=>authModal.show());

document.getElementById('toggleAuth').addEventListener('click', e=>{
  e.preventDefault();
  const isLogin = document.getElementById('authTitle').textContent === 'Login';
  document.getElementById('authTitle').textContent = isLogin?'Register':'Login';
  document.getElementById('authForm').reset();
  document.getElementById('authResult').textContent = '';
});

// Authentication
document.getElementById('authForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const email = document.getElementById('authEmail').value;
  const password = document.getElementById('authPassword').value;
  const isLogin = document.getElementById('authTitle').textContent === 'Login';
  const endpoint = isLogin?'/api/customers/login':'/api/customers/register';
  const res = await fetch(endpoint,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({email,password})
  });
  const data = await res.json();
  if(data.error){document.getElementById('authResult').textContent=data.error;return;}
  loggedInCustomer=data;
  authModal.hide();
  showDashboard();
});

// Dashboard
async function showDashboard(){
  document.getElementById('profileMenu').style.display='block';
  document.getElementById('loyaltyPoints').textContent=`Loyalty Points: ${loggedInCustomer.points||0}`;
  const carList=document.getElementById('carList'); carList.innerHTML='';
  (loggedInCustomer.cars||[]).forEach(c=>{const li=document.createElement('li');li.textContent=c;carList.appendChild(li);});
  const res=await fetch(`/api/customers/${loggedInCustomer.id}/bookings`);
  const bookings=await res.json();
  const history=document.getElementById('bookingHistory'); history.innerHTML='';
  bookings.forEach(b=>{const li=document.createElement('li');li.textContent=`${b.service_name} - ${b.status}`;history.appendChild(li);});
}

// Logout
document.getElementById('logoutBtn').addEventListener('click', ()=>{
  loggedInCustomer=null;
  document.getElementById('profileMenu').style.display='none';
  authModal.show();
});

// Add Car
document.getElementById('addCarBtn').addEventListener('click', ()=>{
  const car = prompt('Enter car registration number:');
  if(car){loggedInCustomer.cars=loggedInCustomer.cars||[];loggedInCustomer.cars.push(car);showDashboard();}
});

// Populate services carousel
async function loadServices(){
  const res=await fetch('/api/services');
  const services=await res.json();
  const inner=document.getElementById('servicesInner');
  services.forEach((s,i)=>{
    const div=document.createElement('div');
    div.className='carousel-item'+(i===0?' active':'');
    div.style.backgroundImage=`url('https://via.placeholder.com/600x250?text=${encodeURIComponent(s.name)}')`;
    div.innerHTML=`<div class="carousel-caption d-none d-md-block"><h5>${s.name}</h5><p>${s.description}</p></div>`;
    inner.appendChild(div);
  });
}

loadServices();
</script>

</body>
</html>