<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mechanic Booking System</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { padding: 0; margin: 0; font-family: Arial, sans-serif; background: #f5f5f5; }
  .container { max-width: 900px; margin: auto; padding: 20px; }
  .service-card { background: white; margin-bottom: 10px; padding: 10px; border-radius: 8px; }
  #ticketPopup, #diagPopup { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); 
    background:white; padding:20px; border-radius:10px; z-index:999; width:90%; max-width:400px; }
  #diagPopup { max-width:500px; }
  #footerStatus { position:fixed; bottom:0; left:0; width:100%; background:#007bff; color:white; text-align:center; padding:5px; font-size:14px; cursor:pointer; }
  .close-btn { float:right; cursor:pointer; color:red; font-weight:bold; }
  input, select { width: 100%; margin-bottom: 10px; }
</style>
</head>
<body>

<div class="container">

  <h1 class="text-center mb-4">Book a Service</h1>

  <form id="bookingForm">
    <input type="text" id="name" placeholder="Full Name" required>
    <input type="email" id="email" placeholder="Email" required>
    <input type="tel" id="phone" placeholder="Phone Number (UK)" pattern="^(\+44\s?7\d{3}|\(?07\d{3}\)?)\s?\d{3}\s?\d{3}$" required>
    <input type="text" id="numberPlate" placeholder="Number Plate (UK)" pattern="^[A-Z]{2}[0-9]{2}\s?[A-Z]{3}$" required>
    <input type="text" id="address" placeholder="Address" required>
    <input type="hidden" id="lat">
    <input type="hidden" id="lng">
    
    <select id="serviceSelect" required>
      <option value="">Select Service</option>
    </select>

    <button class="btn btn-primary w-100">Book Service</button>
  </form>

  <h2 class="mt-5">Mechanic Bookings</h2>
  <button class="btn btn-secondary mb-2" id="refreshBookings">Refresh Bookings</button>
  <div id="bookingsList"></div>

  <h2 class="mt-5">Available Services</h2>
  <div id="services"></div>

</div>

<!-- Ticket Popup -->
<div id="ticketPopup">
  <span class="close-btn" onclick="document.getElementById('ticketPopup').style.display='none'">X</span>
  <div id="ticketContent"></div>
</div>

<!-- Diagnostics Popup -->
<div id="diagPopup">
  <span class="close-btn" onclick="document.getElementById('diagPopup').style.display='none'">X</span>
  <h5>System Diagnostics</h5>
  <ul id="diagList"></ul>
</div>

<div id="footerStatus" onclick="toggleDiagnostics()">DB: Connecting...</div>

<script>
  // Auto uppercase and format number plate
  const numberPlateInput = document.getElementById('numberPlate');
  numberPlateInput.addEventListener('input', ()=> {
    let val = numberPlateInput.value.toUpperCase().replace(/\s/g,'');
    if(val.length>=4) val = val.slice(0,4) + ' ' + val.slice(4);
    numberPlateInput.value = val;
  });

  // Auto detect location
  navigator.geolocation.getCurrentPosition(pos => {
    document.getElementById('lat').value = pos.coords.latitude;
    document.getElementById('lng').value = pos.coords.longitude;
    console.log("Location detected:", pos.coords.latitude, pos.coords.longitude);
  });

  // Load services
  fetch('/api/services').then(r=>r.json()).then(services=>{
    const select = document.getElementById('serviceSelect');
    const divServices = document.getElementById('services');
    services.forEach(s=>{
      select.innerHTML += `<option value="${s.id}">${s.name}</option>`;
      divServices.innerHTML += `<div class="service-card"><strong>${s.name}</strong><p>${s.description}</p></div>`;
    });
  });

  // Booking form submission
  document.getElementById('bookingForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const data = {
      name: document.getElementById('name').value,
      email: document.getElementById('email').value,
      phone: document.getElementById('phone').value,
      numberPlate: document.getElementById('numberPlate').value,
      address: document.getElementById('address').value,
      lat: document.getElementById('lat').value,
      lng: document.getElementById('lng').value,
      serviceId: document.getElementById('serviceSelect').value
    };
    const res = await fetch('/api/bookings',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
    const result = await res.json();
    if(result.success){
      document.getElementById('ticketContent').innerHTML = `Booking Confirmed!<br>Ticket ID: ${result.id}<br><img src="/api/qr?bookingId=${result.id}"/>`;
      document.getElementById('ticketPopup').style.display='block';
    } else {
      alert('Booking Failed: ' + result.error);
    }
  });

  // Load mechanic bookings
  async function loadBookings(){
    const res = await fetch('/api/bookings');
    const bookings = await res.json();
    const list = document.getElementById('bookingsList');
    list.innerHTML='';
    bookings.forEach(b=>{
      list.innerHTML += `<div class="service-card">#${b.id} - ${b.name} (${b.numberPlate}) - ${b.status}</div>`;
    });
  }
  document.getElementById('refreshBookings').addEventListener('click', loadBookings);

  // Diagnostics
  async function toggleDiagnostics(){
    const diag = document.getElementById('diagPopup');
    diag.style.display = diag.style.display==='block'?'none':'block';
    const list = document.getElementById('diagList');
    const db = await fetch('/api/db-status').then(r=>r.json());
    const svc = await fetch('/api/services').then(r=>r.json());
    const bk = await fetch('/api/bookings').then(r=>r.json());
    list.innerHTML = `
      <li>Database Connection: ${db.connected ? '✅ Connected' : '❌ Failed'}</li>
      <li>Services API: ${svc.length} loaded</li>
      <li>Bookings API: ${bk.length} loaded</li>
      <li>Geolocation: ${document.getElementById('lat').value}, ${document.getElementById('lng').value}</li>
    `;
  }

  // Update footer DB status
  async function updateFooterDB(){
    const db = await fetch('/api/db-status').then(r=>r.json());
    document.getElementById('footerStatus').innerText = `DB: ${db.connected?'Connected ✅':'Failed ❌'}`;
  }
  setInterval(updateFooterDB,5000);
  updateFooterDB();
</script>

</body>
</html>