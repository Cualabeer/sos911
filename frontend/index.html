<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Customer Booking</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body { font-family: Arial; margin: 20px; }
h2 { color: #333; }
form { max-width: 500px; margin: auto; }
label { display: block; margin-top: 10px; }
input, select, textarea { width: 100%; padding: 8px; margin-top: 5px; }
button { margin-top: 15px; padding: 10px; background: #0077cc; color: white; border: none; cursor: pointer; }
button:hover { background: #005fa3; }
.status { margin-top: 15px; padding: 10px; border-radius: 4px; }
.success { background: #d4edda; color: #155724; }
.error { background: #f8d7da; color: #721c24; }
#map { height: 300px; margin-top: 10px; }
.suggestions { border: 1px solid #ccc; max-height: 120px; overflow-y: auto; background: white; position: absolute; width: calc(100% - 20px); z-index: 1000; }
.suggestion { padding: 8px; cursor: pointer; }
.suggestion:hover { background: #f0f0f0; }
</style>
</head>
<body>

<h2>Book Your Mobile Mechanic</h2>
<form id="bookingForm">
  <label>Name:</label>
  <input type="text" name="customer_name" required>

  <label>Phone:</label>
  <input type="tel" name="phone" required pattern="[0-9]{10,15}">

  <label>Vehicle Reg:</label>
  <input type="text" name="vehicle_reg" required maxlength="10">

  <label>Service:</label>
  <select name="service_id" required>
    <option value="">-- Select Service --</option>
  </select>

  <label>Location:</label>
  <input type="text" name="location" id="locationInput" required placeholder="Detecting your location...">
  <div id="suggestions" class="suggestions"></div>
  <div id="map"></div>

  <input type="hidden" name="lat" id="lat">
  <input type="hidden" name="lng" id="lng">
  <input type="hidden" name="accuracy" id="accuracy">

  <label>Notes (optional):</label>
  <textarea name="notes"></textarea>

  <button type="submit">Book Now</button>
</form>

<div id="status"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const statusDiv = document.getElementById('status');
const locationInput = document.getElementById('locationInput');
const suggestionsDiv = document.getElementById('suggestions');
const latInput = document.getElementById('lat');
const lngInput = document.getElementById('lng');
const accInput = document.getElementById('accuracy');
const serviceSelect = document.querySelector("select[name='service_id']");

// Load services from backend
fetch("https://sos911.onrender.com/services")
  .then(res => res.json())
  .then(services => {
    services.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s.id;
      opt.textContent = `${s.name} (£${s.price})`;
      serviceSelect.appendChild(opt);
    });
  });

// Force vehicle reg uppercase
document.querySelector("input[name='vehicle_reg']").addEventListener("input", e => {
  e.target.value = e.target.value.toUpperCase();
});

// Map init
let map, marker, accuracyCircle;
function initMap(lat, lng, accuracy) {
  map = L.map('map').setView([lat, lng], 16);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  marker = L.marker([lat, lng], { draggable: true }).addTo(map);
  latInput.value = lat;
  lngInput.value = lng;
  accInput.value = accuracy;
  if (accuracy) accuracyCircle = L.circle([lat, lng], { radius: accuracy, color:'blue', opacity:0.2 }).addTo(map);
  marker.on('dragend', e => {
    const pos = marker.getLatLng();
    latInput.value = pos.lat;
    lngInput.value = pos.lng;
    if (accuracyCircle) accuracyCircle.setLatLng(pos);
  });
}

// GPS + reverse geocode
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(async pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const acc = pos.coords.accuracy;
    latInput.value = lat;
    lngInput.value = lng;
    accInput.value = acc;

    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
      const data = await res.json();
      locationInput.value = data.display_name || `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
    } catch(err){ console.error(err); }

    initMap(lat, lng, acc);
  }, err => {
    console.warn("Location denied", err);
    initMap(51.3865, 0.5225, 0); // Medway default
    locationInput.placeholder = "Enter address manually";
  });
}

// Autocomplete
locationInput.addEventListener("input", async () => {
  const query = locationInput.value.trim();
  if(query.length<3){ suggestionsDiv.innerHTML=""; return; }
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`);
    const data = await res.json();
    suggestionsDiv.innerHTML = data.map(place => `<div class="suggestion" data-lat="${place.lat}" data-lon="${place.lon}">${place.display_name}</div>`).join("");
  } catch(err){ console.error(err); }
});
suggestionsDiv.addEventListener("click", e=>{
  if(e.target.classList.contains("suggestion")){
    locationInput.value=e.target.textContent;
    latInput.value=e.target.dataset.lat;
    lngInput.value=e.target.dataset.lon;
    suggestionsDiv.innerHTML="";
    if(marker) marker.setLatLng([e.target.dataset.lat, e.target.dataset.lon]);
    if(accuracyCircle) accuracyCircle.setLatLng([e.target.dataset.lat, e.target.dataset.lon]);
  }
});

// Form submit
document.getElementById('bookingForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const formData = Object.fromEntries(new FormData(e.target));
  try{
    const res = await fetch("https://sos911.onrender.com/bookings", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(formData)
    });
    const result = await res.json();
    if(!result.success) throw new Error("Booking failed");
    statusDiv.className="status success";
    statusDiv.textContent=`✅ Booking confirmed! Ref: ${result.booking.id}`;
    e.target.reset();
  } catch(err){
    statusDiv.className="status error";
    statusDiv.textContent="❌ Booking failed, try again.";
    console.error(err);
  }
});
</script>
</body>
</html>