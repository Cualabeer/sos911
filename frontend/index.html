<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Customer Booking & Diagnostics</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body, html { height: 100%; margin: 0; font-family: Arial, sans-serif; }
  #diagnosticsOverlay {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.8); color:white; overflow-y:auto; z-index:1000;
    display:flex; flex-direction:column; justify-content:center; align-items:center;
    padding:2rem; text-align:left;
  }
  #diagnosticsOverlay h2 { margin-bottom:1rem; }
  #diagnosticsList { list-style:none; padding:0; }
  #diagnosticsList li { margin-bottom:0.5rem; }
  .success { color:#0f0; }
  .fail { color:#f00; }
  #closeDiagBtn { margin-top:1rem; }
</style>
</head>
<body>

<!-- Diagnostics Overlay -->
<div id="diagnosticsOverlay">
  <h2>System Diagnostics</h2>
  <ul id="diagnosticsList">
    <li>Loading...</li>
  </ul>
  <button id="closeDiagBtn" class="btn btn-light">Close</button>
</div>

<!-- Customer Booking Form -->
<div class="container mt-5" style="display:none;" id="bookingForm">
  <h1>Book a Service</h1>
  <form id="serviceForm">
    <div class="mb-3">
      <label for="name" class="form-label">Full Name</label>
      <input type="text" id="name" class="form-control" required>
    </div>
    <div class="mb-3">
      <label for="phone" class="form-label">Phone (UK)</label>
      <input type="tel" id="phone" class="form-control" pattern="^\+44\d{10}$" placeholder="+447911123456" required>
    </div>
    <div class="mb-3">
      <label for="email" class="form-label">Email</label>
      <input type="email" id="email" class="form-control" required>
    </div>
    <div class="mb-3">
      <label for="number_plate" class="form-label">Number Plate (UK)</label>
      <input type="text" id="number_plate" class="form-control" required>
    </div>
    <div class="mb-3">
      <label for="address" class="form-label">Address</label>
      <input type="text" id="address" class="form-control" required>
    </div>
    <button type="submit" class="btn btn-primary">Book Service</button>
  </form>
  <div id="bookingStatus" class="mt-3"></div>
</div>

<script>
async function fetchDiagnostics() {
  const list = document.getElementById('diagnosticsList');
  try {
    const res = await fetch('https://sos911.onrender.com/api/full-diagnostics');
    const diag = await res.json();
    list.innerHTML = '';
    for (const key in diag) {
      if (diag[key].status) {
        const status = diag[key].status === 'OK' ? '✅' : '❌';
        const li = document.createElement('li');
        li.textContent = `${key}: ${status}`;
        li.className = diag[key].status === 'OK' ? 'success' : 'fail';
        list.appendChild(li);
      }
    }
  } catch (err) {
    list.innerHTML = `<li class="fail">Diagnostics failed: ${err.message}</li>`;
  }
}

// Auto-format number plate to uppercase
const numberPlateInput = document.getElementById('number_plate');
numberPlateInput.addEventListener('input', () => {
  numberPlateInput.value = numberPlateInput.value.toUpperCase().replace(/[^A-Z0-9]/g,'');
});

// Close diagnostics overlay
document.getElementById('closeDiagBtn').addEventListener('click', () => {
  document.getElementById('diagnosticsOverlay').style.display = 'none';
  document.getElementById('bookingForm').style.display = 'block';
});

// Booking form submit
document.getElementById('serviceForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = {
    name: document.getElementById('name').value,
    phone: document.getElementById('phone').value,
    email: document.getElementById('email').value,
    number_plate: document.getElementById('number_plate').value,
    address: document.getElementById('address').value
  };
  const statusDiv = document.getElementById('bookingStatus');
  try {
    const res = await fetch('https://sos911.onrender.com/api/bookings', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    const json = await res.json();
    if(res.ok) {
      statusDiv.textContent = 'Booking successful!';
      statusDiv.className = 'text-success';
    } else {
      statusDiv.textContent = 'Booking failed: ' + (json.error || 'Unknown');
      statusDiv.className = 'text-danger';
    }
  } catch(err) {
    statusDiv.textContent = 'Booking failed: ' + err.message;
    statusDiv.className = 'text-danger';
  }
});

// Run diagnostics on page load
window.onload = fetchDiagnostics;
</script>

</body>
</html>