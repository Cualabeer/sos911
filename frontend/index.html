<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile Mechanic Booking</title>
<style>
  body {margin:0;font-family:Arial,sans-serif;background:#f4f4f4;}
  header{background:#222;color:white;padding:1em;text-align:center;}
  main{padding:1em;}
  .service-card{background:white;margin:1em 0;padding:1em;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.2);}
  .carousel{display:flex;overflow-x:auto;}
  .carousel::-webkit-scrollbar{display:none;}
  .btn{padding:0.5em 1em;background:#007bff;color:white;border:none;border-radius:5px;cursor:pointer;margin:0.3em;}
  .btn:hover{background:#0056b3;}
  .booking-history{margin-top:2em;}
  .popup{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;}
  .popup-content{background:white;padding:2em;border-radius:10px;width:90%;max-width:400px;}
  .close{float:right;cursor:pointer;font-weight:bold;}
  footer{background:#222;color:white;padding:1em;text-align:center;margin-top:2em;}
</style>
</head>
<body>

<header>
  <h1>Mobile Mechanic Booking</h1>
</header>

<main>
  <div id="hero">
    <h2>Quick Booking, Reliable Service</h2>
    <p>Book your car service instantly. Loyalty points, QR tickets & more.</p>
    <button class="btn" id="loginBtn">Login / Register</button>
  </div>

  <h3>Our Services</h3>
  <div class="carousel" id="servicesCarousel"></div>

  <div class="booking-history" id="bookingHistory"></div>
</main>

<div class="popup" id="authPopup">
  <div class="popup-content">
    <span class="close" id="popupClose">&times;</span>
    <h3 id="popupTitle">Login</h3>
    <form id="authForm">
      <input type="email" id="email" placeholder="Email" required style="width:100%;margin:0.5em 0;padding:0.5em;">
      <input type="password" id="password" placeholder="Password" required style="width:100%;margin:0.5em 0;padding:0.5em;">
      <input type="text" id="name" placeholder="Full Name" style="width:100%;margin:0.5em 0;padding:0.5em;display:none;">
      <input type="text" id="phone" placeholder="Phone" style="width:100%;margin:0.5em 0;padding:0.5em;display:none;">
      <input type="text" id="reg_plate" placeholder="Car Reg Plate" style="width:100%;margin:0.5em 0;padding:0.5em;display:none;">
      <input type="text" id="address" placeholder="Address" style="width:100%;margin:0.5em 0;padding:0.5em;display:none;">
      <button type="submit" class="btn">Submit</button>
      <button type="button" class="btn" id="toggleAuth">Switch to Register</button>
    </form>
  </div>
</div>

<footer>
  &copy; 2025 Mobile Mechanic
</footer>

<script>
const loginBtn = document.getElementById('loginBtn');
const authPopup = document.getElementById('authPopup');
const popupClose = document.getElementById('popupClose');
const toggleAuth = document.getElementById('toggleAuth');
const popupTitle = document.getElementById('popupTitle');
const authForm = document.getElementById('authForm');

let registerMode = false;

loginBtn.onclick = () => authPopup.style.display = 'flex';
popupClose.onclick = () => authPopup.style.display = 'none';

toggleAuth.onclick = () => {
  registerMode = !registerMode;
  popupTitle.textContent = registerMode ? 'Register' : 'Login';
  document.getElementById('name').style.display = registerMode ? 'block':'none';
  document.getElementById('phone').style.display = registerMode ? 'block':'none';
  document.getElementById('reg_plate').style.display = registerMode ? 'block':'none';
  document.getElementById('address').style.display = registerMode ? 'block':'none';
  toggleAuth.textContent = registerMode ? 'Switch to Login':'Switch to Register';
};

authForm.onsubmit = async (e) => {
  e.preventDefault();
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  if(registerMode){
    const name = document.getElementById('name').value;
    const phone = document.getElementById('phone').value;
    const reg_plate = document.getElementById('reg_plate').value;
    const address = document.getElementById('address').value;
    const res = await fetch('/api/customers/register',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({name,email,phone,reg_plate,address,password})
    });
    const data = await res.json();
    if(data.error){alert(data.error);return;}
    alert('Registered! You can now login.');
    registerMode=false;
    toggleAuth.click();
  } else {
    const res = await fetch('/api/customers/login',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({email,password})
    });
    const data = await res.json();
    if(data.error){alert(data.error);return;}
    authPopup.style.display='none';
    loadBookings(data.id);
  }
};

async function loadServices(){
  const res = await fetch('/api/diagnostics');
  const data = await res.json();
  const carousel = document.getElementById('servicesCarousel');
  const servicesList = [
    {name:'Oil Change',desc:'Full synthetic oil change'},
    {name:'Brake Inspection',desc:'Check and adjust brakes'},
    {name:'Battery Replacement',desc:'Replace old battery'}
  ];
  servicesList.forEach(s=>{
    const card=document.createElement('div');
    card.className='service-card';
    card.innerHTML=`<h4>${s.name}</h4><p>${s.desc}</p><button class="btn">Book Now</button>`;
    carousel.appendChild(card);
  });
}

async function loadBookings(customerId){
  const res = await fetch('/api/bookings/'+customerId);
  const data = await res.json();
  const history = document.getElementById('bookingHistory');
  history.innerHTML='<h3>Your Bookings</h3>';
  data.forEach(b=>{
    const div = document.createElement('div');
    div.className='service-card';
    div.innerHTML=`<h4>${b.service_name}</h4><p>${b.service_desc}</p>
    <p>Status: ${b.status}</p><img src="${b.qr_code}" style="width:100px;">`;
    history.appendChild(div);
  });
}

// Initial load
loadServices();
</script>

</body>
</html>