<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mechanic Service Booking</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { font-family: sans-serif; margin:0; padding:0; }
  #preloader { position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;display:flex;flex-direction:column;justify-content:flex-start;align-items:center;z-index:9999;padding-top:40px; }
  #diagList { list-style:none;padding:0;margin:0;width:90%;max-width:500px;overflow-y:auto;max-height:60vh;border:1px solid #ddd;border-radius:8px;padding:10px; }
  #progressBarContainer { width:90%; max-width:500px; height:20px;border:1px solid #ddd;border-radius:10px; overflow:hidden;margin-bottom:20px; }
  #progressBar { width:0%;height:100%;background:#007bff; }
  .service-card { margin-bottom:20px; }
  .faq-item { margin-bottom:10px; }
  footer { background:#f8f9fa;padding:20px;text-align:center; font-size:0.9rem; }
</style>
</head>
<body>

<!-- Preloader -->
<div id="preloader">
  <button id="closeDiag" class="btn btn-danger btn-sm" style="position:absolute;top:10px;right:10px;">Close</button>
  <div id="progressBarContainer"><div id="progressBar"></div></div>
  <h2>Running System Diagnostics...</h2>
  <ul id="diagList"></ul>
</div>

<!-- Main Site -->
<div id="mainSite" style="display:none;">

  <!-- Hero -->
  <section class="p-5 text-center bg-primary text-white">
    <h1>Welcome to SOS Mechanics</h1>
    <p>Book your car service quickly and efficiently.</p>
  </section>

  <!-- Services -->
  <section class="p-5">
    <h2 class="mb-4">Our Services</h2>
    <div class="row" id="servicesContainer">
      <!-- Dynamically filled -->
    </div>
  </section>

  <!-- FAQ -->
  <section class="p-5 bg-light">
    <h2 class="mb-4">Frequently Asked Questions</h2>
    <div class="accordion" id="faqAccordion">
      <div class="accordion-item faq-item">
        <h2 class="accordion-header" id="faq1">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse1">How do I book?</button>
        </h2>
        <div id="collapse1" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
          <div class="accordion-body">Use the booking form below. Fill in all fields and submit.</div>
        </div>
      </div>
      <div class="accordion-item faq-item">
        <h2 class="accordion-header" id="faq2">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse2">Where do you operate?</button>
        </h2>
        <div id="collapse2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
          <div class="accordion-body">We cover the Medway area and surroundings.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Booking Form -->
  <section class="p-5">
    <h2 class="mb-4">Book a Service</h2>
    <form id="bookingForm" class="row g-3 needs-validation" novalidate>
      <div class="col-md-6">
        <label for="name" class="form-label">Full Name</label>
        <input type="text" class="form-control" id="name" required>
        <div class="invalid-feedback">Please enter your name.</div>
      </div>
      <div class="col-md-6">
        <label for="phone" class="form-label">Phone (UK)</label>
        <input type="tel" class="form-control" id="phone" pattern="^(\+44\s?7\d{3}|\(?07\d{3}\)?)\s?\d{3}\s?\d{3}$" required>
        <div class="invalid-feedback">Enter a valid UK phone number.</div>
      </div>
      <div class="col-md-6">
        <label for="email" class="form-label">Email</label>
        <input type="email" class="form-control" id="email" required>
        <div class="invalid-feedback">Enter a valid email address.</div>
      </div>
      <div class="col-md-6">
        <label for="reg" class="form-label">Number Plate (UK)</label>
        <input type="text" class="form-control" id="reg" required>
        <div class="invalid-feedback">Enter a valid UK number plate.</div>
      </div>
      <div class="col-md-12">
        <label for="address" class="form-label">Address</label>
        <input type="text" class="form-control" id="address" required>
        <div class="invalid-feedback">Enter your address.</div>
      </div>
      <div class="col-md-12">
        <label for="service" class="form-label">Select Service</label>
        <select class="form-select" id="service" required></select>
        <div class="invalid-feedback">Select a service.</div>
      </div>
      <div class="col-12">
        <button type="submit" class="btn btn-primary">Book Service</button>
      </div>
    </form>
  </section>

  <footer>
    <span id="dbStatus">Database status: Checking...</span>
    <button class="btn btn-sm btn-secondary" id="runDiag">Run Diagnostics</button>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const preloader = document.getElementById('preloader');
const mainSite = document.getElementById('mainSite');
const dbStatusEl = document.getElementById('dbStatus');
const serviceSelect = document.getElementById('service');

// Diagnostics preloader
async function runPreloader(){
    const diagList = document.getElementById('diagList');
    const progressBar = document.getElementById('progressBar');
    const results = [];

    function updateDiag(){
        diagList.innerHTML = '';
        results.forEach(item=>{
            const li = document.createElement('li');
            li.textContent = item.text;
            li.style.color = item.ok ? 'green' : 'red';
            diagList.appendChild(li);
        });
        progressBar.style.width = Math.round((results.length/7)*100) + '%';
        diagList.scrollTop = diagList.scrollHeight;
    }

    function pushResult(text, ok=true){
        results.push({text:ok?'✅ '+text:'❌ '+text, ok});
        updateDiag();
    }

    // Check database and APIs
    try {
        const res = await fetch('/api/db-status');
        const data = await res.json();
        pushResult(`Database connected`, data.connected);
        pushResult(`Services loaded: ${data.services || 0}`);
        pushResult(`Bookings loaded: ${data.bookings || 0}`);
    } catch(e){ pushResult(`Database/API error: ${e.message}`, false); }

    // Geolocation
    if(navigator.geolocation){
        await new Promise(resolve=>{
            navigator.geolocation.getCurrentPosition(
                pos=>{
                    pushResult(`Location: Lat ${pos.coords.latitude.toFixed(6)}, Lng ${pos.coords.longitude.toFixed(6)}`);
                    resolve();
                },
                err=>{
                    pushResult(`Location Error: ${err.message}`, false);
                    resolve();
                }
            );
        });
    }

    // Feature checks
    pushResult(`LocalStorage supported`, !!window.localStorage);
    pushResult(`Cookies enabled`, navigator.cookieEnabled);
    pushResult(`Fetch API supported`, !!window.fetch);
    try {
        const canvas = document.createElement('canvas');
        if(!canvas.getContext) throw new Error();
        pushResult('QR Code Generation supported');
    } catch(e){ pushResult(`QR Code Generation failed`, false); }

    // Done
    setTimeout(()=>{
        preloader.style.display='none';
        mainSite.style.display='block';
    }, 500);
}

// Populate services dropdown
async function loadServices(){
    try {
        const res = await fetch('/api/services');
        const data = await res.json();
        data.forEach(s=>{
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.textContent = s.name;
            serviceSelect.appendChild(opt);
        });
    } catch(e){ console.error('Services load failed', e); }
}

// Booking form validation
const form = document.getElementById('bookingForm');
form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(!form.checkValidity()){ form.classList.add('was-validated'); return; }
    // Post booking
    const bookingData = {
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        reg: document.getElementById('reg').value.toUpperCase(),
        address: document.getElementById('address').value,
        serviceId: document.getElementById('service').value
    };
    try {
        const res = await fetch('/api/bookings', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(bookingData)
        });
        const data = await res.json();
        alert(data.message || 'Booking successful');
    } catch(e){ alert('Booking failed: '+e.message); }
});

document.getElementById('closeDiag').addEventListener('click', ()=>preloader.style.display='none');
window.addEventListener('DOMContentLoaded', ()=>{
    runPreloader();
    loadServices();
});
</script>
</body>
</html>