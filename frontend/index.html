<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile Mechanic Booking</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background: #f5f5f5; font-family: Arial, sans-serif; }
  .container { max-width: 700px; margin: 30px auto; padding: 20px; background: #fff; border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.1);}
  h1 { text-align:center; margin-bottom:30px;}
  .form-label { font-weight: bold; }
  .btn-primary { width:100%; font-size:1.2rem; }
  #ticketPopup { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; padding:30px; border-radius:15px; box-shadow:0 0 25px rgba(0,0,0,0.3); z-index:999; }
  #ticketPopup h2 { text-align:center; margin-bottom:20px; }
  #ticketPopup canvas { display:block; margin: 0 auto; }
  #ticketPopup button { margin-top:20px; }
  footer { margin-top:20px; text-align:center; font-size:0.9rem; color:green;}
</style>
</head>
<body>

<div class="container">
  <h1>Book Service</h1>
  <form id="bookingForm">
    <div class="mb-3">
      <label class="form-label">Full Name</label>
      <input type="text" class="form-control" id="name" placeholder="John Smith" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Email</label>
      <input type="email" class="form-control" id="email" placeholder="john@example.com" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Phone (UK)</label>
      <input type="tel" class="form-control" id="phone" placeholder="07123456789" pattern="^07\d{9}$" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Number Plate</label>
      <input type="text" class="form-control" id="numberPlate" placeholder="AB12CDE" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Service</label>
      <select class="form-select" id="service" required>
        <option value="">Select Service</option>
        <option value="oil">Oil Change</option>
        <option value="brake">Brake Check</option>
        <option value="battery">Battery Replacement</option>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label">Location</label>
      <input type="text" class="form-control" id="location" placeholder="Detecting..." required>
      <input type="hidden" id="lat">
      <input type="hidden" id="lng">
    </div>
    <button type="submit" class="btn btn-primary">Book Service</button>
  </form>
</div>

<div id="ticketPopup">
  <h2>Booking Ticket</h2>
  <canvas id="qrCanvas"></canvas>
  <p id="ticketDetails"></p>
  <button class="btn btn-secondary" onclick="document.getElementById('ticketPopup').style.display='none'">Close</button>
</div>

<footer id="dbStatus">Connecting to database...</footer>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<script>
  // Auto-format number plate
  const numberPlateInput = document.getElementById('numberPlate');
  numberPlateInput.addEventListener('input', e => {
    let val = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,'');
    e.target.value = val;
  });

  // Detect location + reverse geocode
  async function detectLocation() {
    const locInput = document.getElementById('location');
    const latInput = document.getElementById('lat');
    const lngInput = document.getElementById('lng');
    if (!navigator.geolocation) { locInput.value = 'Geolocation not supported'; return; }

    navigator.geolocation.getCurrentPosition(async pos => {
      latInput.value = pos.coords.latitude;
      lngInput.value = pos.coords.longitude;
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latInput.value}&lon=${lngInput.value}`);
        const data = await res.json();
        locInput.value = data.display_name || '';
      } catch(err) { locInput.value = `Error reverse geocoding`; }
    }, err => { locInput.value = `Geolocation error: ${err.message}`; });
  }
  window.addEventListener('load', detectLocation);

  // DB status fetch
  async function checkDbStatus() {
    const footer = document.getElementById('dbStatus');
    try {
      const res = await fetch('https://sos911.onrender.com/db-status'); // your backend endpoint
      const data = await res.json();
      footer.textContent = data.message;
    } catch(err) {
      footer.style.color = 'red';
      footer.textContent = `❌ Database not connected: ${err.message}`;
    }
  }
  window.addEventListener('load', checkDbStatus);

  // Booking form submit
  document.getElementById('bookingForm').addEventListener('submit', async e => {
    e.preventDefault();
    const formData = {
      name: document.getElementById('name').value,
      email: document.getElementById('email').value,
      phone: document.getElementById('phone').value,
      numberPlate: document.getElementById('numberPlate').value,
      service: document.getElementById('service').value,
      location: document.getElementById('location').value,
      lat: document.getElementById('lat').value,
      lng: document.getElementById('lng').value
    };

    try {
      const res = await fetch('https://sos911.onrender.com/bookings', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(formData)
      });
      const result = await res.json();
      if (result.success) {
        // Generate QR
        const canvas = document.getElementById('qrCanvas');
        QRCode.toCanvas(canvas, JSON.stringify({bookingId: result.id, numberPlate: formData.numberPlate}));
        document.getElementById('ticketDetails').textContent = `Booking for ${formData.name}, Service: ${formData.service}`;
        document.getElementById('ticketPopup').style.display = 'block';
      } else {
        alert('Booking failed: ' + result.message);
      }
    } catch(err) {
      alert('Booking failed: ' + err.message);
    }
  });
</script>

</body>
</html>