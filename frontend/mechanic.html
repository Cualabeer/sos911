<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mechanic Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body { padding: 20px; }
#diagnostics { position:fixed;bottom:0;left:0;width:100%;background:#eee;display:none;max-height:50%;overflow:auto; }
</style>
</head>
<body>

<h1>Mechanic Dashboard</h1>

<div id="loginPrompt" class="mb-3">
  <label>Set a new password (first-time login)</label>
  <input type="password" id="newPassword" class="form-control" placeholder="Enter new password">
  <button id="savePassword" class="btn btn-primary mt-2">Save Password</button>
</div>

<h2>Bookings</h2>
<table class="table table-striped" id="bookingTable">
  <thead>
    <tr>
      <th>Customer</th>
      <th>Service</th>
      <th>Address</th>
      <th>Plate</th>
      <th>Status</th>
      <th>QR</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="diagnostics">
  <h5>System Diagnostics <button id="closeDiag" class="btn btn-sm btn-danger float-end">Close</button></h5>
  <pre id="diagContent"></pre>
</div>

<footer>
  <button id="diagBtn" class="btn btn-secondary">Check System</button>
</footer>

<script>
async function loadBookings(){
  const res = await fetch('http://localhost:3000/api/bookings');
  const bookings = await res.json();
  const tbody = document.querySelector('#bookingTable tbody');
  tbody.innerHTML='';
  bookings.forEach(b=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${b.customer_id}</td>
      <td>${b.service_id}</td>
      <td>${b.address}</td>
      <td>${b.number_plate}</td>
      <td>${b.status}</td>
      <td><button class="btn btn-sm btn-info" onclick="showQR(${b.id})">QR</button></td>
      <td>
        <button class="btn btn-sm btn-success" onclick="startJob(${b.id})">Start</button>
        <button class="btn btn-sm btn-warning" onclick="completeJob(${b.id})">Complete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}
loadBookings();

async function startJob(id){
  await fetch(`http://localhost:3000/api/bookings`,{
    method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id,status:'in_progress'})
  });
  loadBookings();
}

async function completeJob(id){
  await fetch(`http://localhost:3000/api/bookings`,{
    method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id,status:'completed'})
  });
  loadBookings();
}

async function showQR(id){
  const res = await fetch(`http://localhost:3000/api/bookings/${id}`);
  const data = await res.json();
  alert('QR Code URL: '+data.qr_code);
}

document.getElementById('savePassword').onclick=()=>{
  const pwd=document.getElementById('newPassword').value;
  if(pwd) alert('Password set!');
  document.getElementById('loginPrompt').style.display='none';
};

// Diagnostics
document.getElementById('diagBtn').onclick=async ()=>{
  const res = await fetch('http://localhost:3000/api/diagnostics');
  const diag = await res.json();
  document.getElementById('diagContent').textContent=JSON.stringify(diag,null,2);
  document.getElementById('diagnostics').style.display='block';
};
document.getElementById('closeDiag').onclick=()=>document.getElementById('diagnostics').style.display='none';
</script>

</body>
</html>